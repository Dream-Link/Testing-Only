<!DOCTYPE html>
<html lang="hi">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4th Grade Paper Analysis by MP SALODIYA</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

 <style id="main-styles">
:root {
    --primary-color: #0d6efd;
    --primary-dark: #0b5ed7;
    --primary-light: #cfe2ff;
    --secondary-color: #6c757d;
    --success-color: #198754;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #0dcaf0;
    
    --bg-color: #f8f9fa;
    --surface-color: #ffffff;
    --font-color: #212529;
    --font-color-light: #6c757d;
    --border-color: #dee2e6;
    
    --success-bg: #d1e7dd;
    --danger-bg: #f8d7da;
    --special-bg: #fff3cd;
    --subtle-bg: #f1f3f5;

    --font-family-primary: 'Noto Sans Devanagari', sans-serif;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
    --border-radius: 0.75rem;
    --border-radius-sm: 0.5rem;
}

* { 
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html { 
    font-size: 16px; 
}

body {
    font-family: var(--font-family-primary);
    background: linear-gradient(135deg, var(--bg-color) 0%, #e9ecef 100%);
    color: var(--font-color);
    line-height: 1.6;
    min-height: 100vh;
}

/* ==================== SHIFT SELECTOR PAGE ==================== */
#shift-selector-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.selector-container {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 3rem 2rem;
    box-shadow: var(--shadow-lg);
    max-width: 1200px;
    width: 100%;
    text-align: center;
    backdrop-filter: blur(10px);
}

.selector-container h2 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 1rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.selector-container .subtitle {
    font-size: 1.2rem;
    color: var(--font-color-light);
    margin-bottom: 3rem;
    font-weight: 500;
}

.shift-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.shift-btn {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.5rem;
    background: var(--surface-color);
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    text-decoration: none;
    cursor: pointer;
    text-align: left;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.shift-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.shift-btn:hover::before {
    left: 100%;
}

.shift-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-color);
}

.shift-btn .icon {
    font-size: 1.75rem;
    color: var(--primary-color);
    width: 60px;
    height: 60px;
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, var(--primary-light), #e3f2fd);
    border-radius: 50%;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.shift-btn:hover .icon {
    transform: scale(1.1);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

.shift-btn .text {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--font-color);
    transition: color 0.3s;
}

.shift-btn:hover .text {
    color: var(--primary-dark);
}

.selector-footer {
    margin-top: 3rem;
    font-size: 0.9rem;
    color: var(--secondary-color);
    line-height: 1.6;
}

.selector-footer p {
    margin: 0.75rem 0;
}

.features-box {
    background: linear-gradient(135deg, var(--surface-color), var(--subtle-bg));
    border: 1px solid var(--primary-light);
    border-left: 5px solid var(--primary-color);
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-top: 2rem;
    text-align: left;
    box-shadow: var(--shadow-sm);
}

.features-box h4 {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-dark);
    margin-bottom: 1rem;
}

.features-box ul {
    list-style: none;
    padding: 0;
}

.features-box li {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.features-box li::before {
    content: '✓';
    position: absolute;
    left: 0;
    top: 0;
    color: var(--success-color);
    font-weight: bold;
    font-size: 1.1rem;
}

.creator-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

.creator-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* ==================== QUESTION PAPER PAGE ==================== */
#question-paper-page {
    display: none;
    flex-direction: column;
    min-height: 100vh;
}

.top-sticky-bar {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: var(--surface-color);
    box-shadow: var(--shadow-md);
    border-bottom: 1px solid var(--border-color);
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    gap: 1rem;
}

.header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    flex-grow: 1;
    text-align: center;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
}

.header-controls label {
    font-weight: 500;
    color: var(--font-color-light);
}

.header-controls select,
.header-controls button {
    padding: 0.6rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    background: var(--surface-color);
    font-family: inherit;
    cursor: pointer;
    transition: all 0.3s ease;
}

.header-controls select:focus,
.header-controls button:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}

#toggle-summary-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    font-weight: 600;
}

#header-print-btn {
    background: var(--success-color);
    color: white;
    border: none;
}

.summary-bar {
    padding: 1.5rem 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-top: 1px solid var(--border-color);
}

.summary-bar.hidden {
    display: none;
}

.summary-item {
    text-align: center;
    padding: 1rem;
    border-radius: var(--border-radius-sm);
    background: var(--surface-color);
    box-shadow: var(--shadow-sm);
    transition: transform 0.3s ease;
}

.summary-item:hover {
    transform: translateY(-2px);
}

.summary-item .count {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.2;
}

.summary-item .label {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    opacity: 0.8;
    margin-top: 0.5rem;
}

.container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 2rem;
}

.controls-bar {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
}

.filter-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
}

.filter-buttons button {
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: 2rem;
    background: var(--surface-color);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.filter-buttons button.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.question-block {
    background: var(--surface-color);
    margin-bottom: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.question-block:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary-light);
}

.question-info-bar {
    background: linear-gradient(135deg, var(--subtle-bg), #e9ecef);
    padding: 1rem 1.5rem;
    font-size: 0.85rem;
    color: var(--font-color-light);
    border-bottom: 1px solid var(--border-color);
}

.question-content {
    padding: 1.5rem;
}

.question-content h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.3rem;
    font-weight: 600;
    line-height: 1.6;
    color: var(--font-color);
}

.question-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--border-radius-sm);
    margin: 1rem 0;
    box-shadow: var(--shadow-sm);
}

.options-container {
    background: linear-gradient(135deg, var(--subtle-bg), #f8f9fa);
    padding: 1.5rem;
}

.options-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.options-grid li:last-child:nth-child(odd) {
    grid-column: 1 / -1;
}

.options-list li {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    padding: 1rem 1.25rem;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.options-list li:hover {
    border-color: var(--primary-color);
    background: rgba(13, 110, 253, 0.05);
    transform: translateX(5px);
}

.options-list li.correct {
    background: var(--success-bg);
    border-color: var(--success-color);
    color: var(--success-color);
}

.options-list li.incorrect {
    background: var(--danger-bg);
    border-color: var(--danger-color);
    color: var(--danger-color);
}

.options-list li.special {
    background: var(--special-bg);
    border-color: var(--warning-color);
    color: #856404;
}

.options-list li.selected-neutral {
    background: #e9ecef;
    border-color: #6c757d;
    color: var(--font-color);
}

.correct-answer-display {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 2px solid var(--border-color);
    font-weight: 600;
    color: var(--success-color);
}

/* ==================== THEME SELECTOR ==================== */
.theme-selector {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 1100;
}

#theme-toggle-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid var(--border-color);
    background: var(--surface-color);
    color: var(--primary-color);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
}

#theme-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-color);
}

#theme-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 0.5rem;
    min-width: 200px;
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease;
}

#theme-dropdown.hidden {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
}

#theme-dropdown li {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-radius: var(--border-radius-sm);
    transition: all 0.3s ease;
    color: var(--font-color);
}

#theme-dropdown li:hover {
    background: var(--primary-light);
    color: var(--primary-dark);
}

/* ==================== MODALS ==================== */
#print-modal-overlay,
#user-info-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

#print-modal,
#user-info-modal {
    background: var(--surface-color);
    padding: 2.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 450px;
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.modal-buttons button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

#cancel-print {
    background: var(--secondary-color);
    color: white;
}

#confirm-print {
    background: var(--primary-color);
    color: white;
}

#get-omr-btn {
    background: var(--success-color);
    color: white;
}

#get-official-key-btn {
    background: #6f42c1;
    color: white;
}

/* ==================== MOBILE STYLES ==================== */
@media (max-width: 768px) {
    html {
        font-size: 14px;
    }

    #shift-selector-page {
        padding: 1rem;
    }

    .selector-container {
        padding: 2rem 1rem;
        margin: 1rem;
    }

    .selector-container h2 {
        font-size: 2rem;
    }

    .shift-selector {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .shift-btn {
        padding: 1.25rem;
    }

    .shift-btn .icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }

    .header {
        padding: 1rem;
        flex-wrap: wrap;
    }

    .header h1 {
        order: 1;
        width: 100%;
        font-size: 1.3rem;
        margin-bottom: 1rem;
    }

    .header-controls {
        order: 2;
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
    }

    .header-controls label {
        display: none;
    }

    .header-controls select,
    .header-controls button {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        flex: 1;
        text-align: center;
    }

    .container {
        margin: 1rem auto;
        padding: 0 1rem;
    }

    .summary-bar {
        padding: 1rem;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .summary-item {
        padding: 0.75rem 0.5rem;
    }

    .summary-item .count {
        font-size: 1.4rem;
    }

    .summary-item .label {
        font-size: 0.7rem;
    }

    .filter-buttons {
        gap: 0.5rem;
    }

    .filter-buttons button {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        flex: 1;
        min-width: calc(50% - 0.5rem);
    }

    .question-content {
        padding: 1rem;
    }

    .options-container {
        padding: 1rem;
    }

    .options-grid {
        grid-template-columns: 1fr;
    }

    .theme-selector {
        top: 1rem;
        right: 1rem;
    }

    #theme-toggle-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
    }

    .modal-buttons {
        justify-content: center;
    }

    .modal-buttons button {
        flex: 1;
        min-width: calc(50% - 0.5rem);
    }
}

/* ==================== PRINT STYLES (UNCHANGED) ==================== */
@media print {
    /* Your existing print styles remain exactly the same */
    body { font-size: 10pt; background-color: #fff !important; color: #000 !important; }
    .question-block, .print-header-details, .official-key-print-container { page-break-inside: avoid; }
    * { background-color: transparent !important; box-shadow: none !important; color: #000 !important; }
    
    .print-header-details { padding: 1cm 1cm 0; }
    .print-header-details h2 { text-align: center; margin-top: 0; margin-bottom: 1rem; font-size: 1.5rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
    .print-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1.5rem; margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ccc !important; border-radius: 8px; }
    .print-info-grid p { margin: 2px 0; font-size: 1rem; }
    .print-paper-code strong, .print-paper-code span { color: red !important; font-weight: bold !important; }
    .print-summary-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 1.5rem; }
    .print-summary-table th, .print-summary-table td { border: 1px solid #999 !important; padding: 5px; font-size: 0.9rem; }
    .print-summary-table th { background-color: #f2f2f2 !important; font-weight: bold; }
    #print-correct-cell { color: var(--success-color) !important; font-weight: bold; }
    #print-incorrect-cell { color: var(--danger-color) !important; font-weight: bold; }
    
    .question-block { margin-bottom: 0.5rem !important; border: none !important; border-bottom: 1px dashed #aaa !important; }
    .question-block:last-of-type { border-bottom: none !important; }
    .question-info-bar { display: none !important; }
    #question-paper-page.hide-q-info .question-info-bar { display: none !important; }
    .question-content, .options-container { padding: 0.4rem 8px !important; }
    .question-content h3 { font-size: 10.5pt; margin: 0 0 0.4rem 0 !important; font-weight: normal; }
    .question-content h3 .print-q-num { font-weight: bold; }
    .options-list { margin-top: 0.3rem !important; gap: 3px !important; }
    .options-list li { padding: 4px 8px !important; font-size: 10pt !important; border: 1px solid #ccc !important; }
    .correct-answer-display { font-size: 9pt; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #ddd !important; }
    .options-list li.correct, .options-list li.incorrect, .options-list li.special, .options-list li.selected-neutral {
        -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
    }
    .options-list li.correct { background-color: var(--success-bg) !important; }
    .options-list li.incorrect { background-color: var(--danger-bg) !important; }
    .options-list li.special { background-color: var(--special-bg) !important; }
    .options-list li.selected-neutral { background-color: #e9ecef !important; }
    
    body.omr-print-body .print-header-details { padding: 0.5cm 1cm 0 !important; }
    body.omr-print-body .print-header-details h2 { font-size: 1.1rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; }
    body.omr-print-body .print-info-grid { gap: 0 0.5rem; margin-bottom: 0.4rem; padding: 0.4rem; }
    body.omr-print-body .print-info-grid p { font-size: 0.75rem; }
    body.omr-print-body .print-summary-table { margin-bottom: 0.5rem; }
    body.omr-print-body .print-summary-table th, body.omr-print-body .print-summary-table td { padding: 2px; font-size: 0.7rem; }
    .omr-grid { display: flex; justify-content: space-between; gap: 10px; padding: 0 1cm 1cm; }
    .omr-column { width: 24%; border: 1px solid #ccc !important; border-radius: 5px; padding: 10px 5px 5px 10px; }
    .omr-row { display: flex; align-items: center; margin-bottom: 5.8px; }
    .omr-q-num { font-weight: bold; width: 35px; }
    .omr-options { display: flex; }
    .omr-bubble { width: 18px; height: 18px; border: 1px solid #000 !important; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; margin-right: 5px; }
    .omr-bubble.filled { background-color: #0d47a1 !important; border-color: #0d47a1 !important; color: white !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
    .omr-bubble.filled-neutral { background-color: #555 !important; border-color: #333 !important; color: white !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }

    .official-key-print-container { padding: 1cm; }
    .official-key-header h1 { text-align: center; font-size: 1.5rem; margin: 0 0 0.5rem 0; }
    .official-key-header p { text-align: center; font-size: 1.1rem; margin: 0 0 1.5rem 0; font-weight: bold; }
    .official-key-grid { display: flex; justify-content: space-around; align-items: flex-start; gap: 1.5rem; }
    .official-key-column { width: 45%; }
    .official-key-table { width: 100%; border-collapse: collapse; }
    .official-key-table th, .official-key-table td { border: 1px solid #333 !important; padding: 5px; text-align: center; font-size: 10pt; }
    .official-key-table th { background-color: #f2f2f2 !important; }
    .official-key-footer {
        margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #ccc !important;
        text-align: center; font-size: 9pt; color: #555 !important;
    }
}

/* ==================== THEME PALETTES ==================== */
:root[data-theme='dark-blue'] {
    --primary-color: #3b82f6; --primary-dark: #2563eb; --primary-light: #1e3a8a;
    --bg-color: #111827; --surface-color: #1f2937; --font-color: #f3f4f6;
    --font-color-light: #9ca3af; --border-color: #374151; --success-bg: #064e3b;
    --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #374151;
}
:root[data-theme='light-green'] {
    --primary-color: #22c55e; --primary-dark: #16a34a; --primary-light: #dcfce7;
}
:root[data-theme='dark-green'] {
    --primary-color: #4ade80; --primary-dark: #22c55e; --primary-light: #14532d;
    --bg-color: #18181b; --surface-color: #27272a; --font-color: #f4f4f5;
    --font-color-light: #a1a1aa; --border-color: #3f3f46; --success-bg: #064e3b;
    --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #3f3f46;
}
:root[data-theme='light-purple'] {
    --primary-color: #8b5cf6; --primary-dark: #7c3aed; --primary-light: #ede9fe;
}
:root[data-theme='dark-purple'] {
    --primary-color: #a78bfa; --primary-dark: #8b5cf6; --primary-light: #3b0764;
    --bg-color: #171321; --surface-color: #251e39; --font-color: #f1f0f5;
    --font-color-light: #a9a2c1; --border-color: #403561; --success-bg: #064e3b;
    --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #403561;
}
:root[data-theme='light-orange'] {
    --primary-color: #f97316; --primary-dark: #ea580c; --primary-light: #ffedd5;
}
:root[data-theme='dark-orange'] {
    --primary-color: #fb923c; --primary-dark: #f97316; --primary-light: #7c2d12;
    --bg-color: #201a18; --surface-color: #302824; --font-color: #f5f0ee;
    --font-color-light: #b0a8a4; --border-color: #514641; --success-bg: #064e3b;
    --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #514641;
}
:root[data-theme='light-teal'] {
    --primary-color: #14b8a6; --primary-dark: #0d9488; --primary-light: #ccfbf1;
}
:root[data-theme='dark-teal'] {
    --primary-color: #2dd4bf; --primary-dark: #14b8a6; --primary-light: #042f2e;
    --bg-color: #0f172a; --surface-color: #1e2b; --font-color: #f1f5f9;
    --font-color-light: #94a3b8; --border-color: #334155; --success-bg: #064e3b;
    --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #334155;
}
:root[data-theme='solarized-light'] {
    --primary-color: #268bd2; --primary-dark: #002b36; --primary-light: #eee8d5;
    --bg-color: #fdf6e3; --surface-color: #eee8d5; --font-color: #657b83;
    --font-color-light: #93a1a1; --border-color: #93a1a1; --success-bg: #dff0d8;
    --danger-bg: #f2dede; --special-bg: #fcf8e3; --subtle-bg: #eee8d5;
}
:root[data-theme='solarized-dark'] {
    --primary-color: #268bd2; --primary-dark: #93a1a1; --primary-light: #073642;
    --bg-color: #002b36; --surface-color: #073642; --font-color: #839496;
    --font-color-light: #586e75; --border-color: #586e75; --success-bg: #2d4f2d;
    --danger-bg: #6b3e3e; --special-bg: #635741; --subtle-bg: #0b4250;
}
</style>
    
</head>
<body>

    <div class="theme-selector">
        <button id="theme-toggle-btn" title="Change Theme">
            <i class="fas fa-palette"></i>
        </button>
        <ul id="theme-dropdown" class="hidden">
            <li data-theme="auto">Auto (System Default)</li>
            <li data-theme="light-blue">Default Light</li>
            <li data-theme="dark-blue">Default Dark</li>
            <li data-theme="light-green">Green Light</li>
            <li data-theme="dark-green">Green Dark</li>
            <li data-theme="light-purple">Purple Light</li>
            <li data-theme="dark-purple">Purple Dark</li>
            <li data-theme="light-orange">Orange Light</li>
            <li data-theme="dark-orange">Dark Dark</li>
            <li data-theme="light-teal">Teal Light</li>
            <li data-theme="dark-teal">Dark Teal</li>
            <li data-theme="solarized-light">Solarized Light</li>
            <li data-theme="solarized-dark">Solarized Dark</li>
        </ul>
    </div>
    <div class="print-only-container">
        <div id="print-fallback-details" class="print-header-details">
            <h2 id="print-title"></h2>
            <div class="print-info-grid">
                <p><strong>नाम:</strong> <span id="print-name"></span></p>
                <p class="print-paper-code"><strong>पेपर कोड:</strong> <span id="print-series"></span></p>
                <p><strong>रोल नंबर:</strong> <span id="print-roll"></span></p>
                <p><strong>RAW Marks:</strong> <span id="print-raw-marks-display"></span></p>
            </div>
            <table class="print-summary-table">
                <thead>
                    <tr>
                        <th>कुल प्रश्न</th> <th>वैध प्रश्न</th> <th>हल किए</th> <th>सही</th> <th>गलत</th> <th>छोड़े (E)</th> <th>Delete</th> <th>अंतिम सही प्रश्न</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span id="print-full-total"></span></td>
                        <td><span id="print-valid-total"></span></td>
                        <td><span id="print-attempted"></span></td>
                        <td id="print-correct-cell"></td>
                        <td id="print-incorrect-cell"></td>
                        <td><span id="print-skipped"></span></td>
                        <td><span id="print-deleted"></span></td>
                        <td id="print-final-rq-display"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="omr-print-container"></div>
        <div id="official-key-print-container"></div>
    </div>

    <div id="shift-selector-page">
        <div class="selector-container">
            <h2>चतुर्थ श्रेणी कर्मचारी</h2>
            <p class="subtitle">कृपया अपनी शिफ़्ट चुनें।</p>
            <div class="shift-selector">
                <a class="shift-btn" data-shift="shift1"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">1st Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift2"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">2nd Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift3"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">3rd Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift4"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">4th Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift5"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">5th Shift 21.09.2025</div></a>
                <a class="shift-btn" data-shift="shift6"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">6th Shift 21.09.2025</div></a>
            </div>
            <div class="selector-footer">
                <p>Last Update: 03.10.2025 22:02</p>
                <p style="text-align:center; color: red;"> सभी प्रश्नों के उत्तर संभावित उत्तर कुंजी के आधार पर हैं, Official Answer Key जारी होने पर UPDATE कर दी जाएगी।</p>
                <p>
                    <a href="https://t.me/Dreamlinkmp" target="_blank" class="creator-link" style="color: blue; text-decoration: underline;">MP Salodiya</a>
                </p>
            </div>
            <div id="leaderboard-section" style="margin-top: 3rem; width: 100%; text-align: left;">
                
                <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin-top: 0; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">लीडरबोर्ड</h4>

                <div class="leaderboard-controls" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label for="leaderboard-shift-filter">शिफ़्ट के अनुसार फ़िल्टर करें:</label>
                    <select id="leaderboard-shift-filter" style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color);">
                        <option value="all">सभी शिफ़्ट</option>
                        <option value="shift1">1st Shift</option>
                        <option value="shift2">2nd Shift</option>
                        <option value="shift3">3rd Shift</option>
                        <option value="shift4">4th Shift</option>
                        <option value="shift5">5th Shift</option>
                        <option value="shift6">6th Shift</option>
                    </select>
                    <button id="view-leaderboard-btn" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; background-color: var(--primary-color); color: white; cursor: pointer;">लीडरबोर्ड देखें</button>
                </div>

                <div id="leaderboard-table-container" style="overflow-x: auto; display: none; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                    <table id="leaderboard-table" style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">रैंक</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">नाम</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">रॉ मार्क्स</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">सही</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">गलत</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">छोड़े गए (E)</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">शिफ़्ट</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                        </tbody>
                    </table>
                    <p id="leaderboard-loading" style="text-align: center; padding: 1rem; display: none;">लोड हो रहा है...</p>
                </div>
            </div> 
         </div>
    </div>

    <div id="question-paper-page">
        <div class="top-sticky-bar">
            <div class="header">
                <button id="toggle-info-bar-btn" title="Toggle Question Info"><i class="fas fa-eye"></i></button>
                <h1 id="shift-title">Shift Title</h1>
                <button id="reset-answers-btn" title="Reset Answers"><i class="fas fa-sync-alt"></i></button>
                <div class="header-controls">
                    <label for="series-select">Paper Code:</label>
                    <select id="series-select"></select>
                    <button id="toggle-summary-btn">Show Result</button>
                    <button id="header-print-btn"><i class="fas fa-print"></i><span class="print-text"> Print</span></button>
                </div>
            </div>
            <div class="summary-bar hidden">
                <div id="total-item" class="summary-item"><div id="total-count" class="count">0</div><div class="label">Valid Que.</div></div>
                <div id="attempted-item" class="summary-item"><div id="attempted-count" class="count">0</div><div class="label">Attempt</div></div>
                <div id="correct-item" class="summary-item"><div id="correct-count" class="count">0</div><div class="label">Right</div></div>
                <div id="incorrect-item" class="summary-item"><div id="incorrect-count" class="count">0</div><div class="label">Wrong</div></div>
                <div id="skipped-item" class="summary-item"><div id="skipped-count" class="count">0</div><div class="label">Skip (E)</div></div>
                <div id="deleted-item" class="summary-item"><div id="deleted-count" class="count">0</div><div class="label">Deleted</div></div>
                <div id="right-que-item" class="summary-item"><div id="right-que-value" class="count">0.00</div><div class="label">Final R.Q.</div></div>
                <div id="raw-marks-item" class="summary-item"><div id="raw-marks-value" class="count">0.00</div><div class="label">RAW Marks</div></div>
                <div id="unattempted-warning-item" class="summary-item">
                    <span>अभी तक <strong id="unattempted-count">0</strong> प्रश्नों में कोई भी ऑप्शन टिक नहीं है।</span>
                </div>
                </div>
        </div>
        <div class="container">
            <div class="controls-bar">
                <div class="filter-buttons">
                    <button class="active" data-filter="all">All</button>
                    <button data-filter="correct">Right</button>
                    <button data-filter="incorrect">Wrong</button>
                    <button data-filter="skipped">Skip (E)</button>
                    <button data-filter="deleted">Deleted</button>
                </div>
            </div>
            <div id="questions-container"></div>
        </div>
    </div>

    <div id="print-modal-overlay">
        <div id="print-modal">
            <h2>Print Details</h2>
            <label for="student-name">Name:</label>
            <input type="text" id="student-name" placeholder="Your Name">
            <label for="student-roll">Roll No.:</label>
            <input type="text" id="student-roll" placeholder="Your Roll No.">
            <div class="modal-buttons">
                <button id="cancel-print">Cancel</button>
                <button id="get-official-key-btn">Answer Key</button>
                <button id="get-omr-btn">Print OMR</button>
                <button id="confirm-print">Paper Print</button>
            </div>
        </div>
    </div>
    
    <div id="user-info-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2001; align-items: center; justify-content: center; padding: 1rem;">
        <div id="user-info-modal" style="background: var(--surface-color); color: var(--font-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); width: 100%; max-width: 400px;">
            <h2 style="margin-top: 0;">Welcome!</h2>
            <p style="margin: 0 0 1.5rem 0; color: var(--font-color-light);">कृपया शुरू करने से पहले अपना नाम और रोल नंबर दर्ज करें। यह नाम लीडरबोर्ड & प्रिन्ट मे दिखाई देगा </p>
            <label for="initial-student-name" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Name:</label>
            <input type="text" id="initial-student-name" placeholder="Your Name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; margin-bottom: 1rem; background-color: var(--bg-color); color: var(--font-color);">
            <label for="initial-student-roll" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Roll No.:</label>
            <input type="text" id="initial-student-roll" placeholder="Your Roll No." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; margin-bottom: 1rem; background-color: var(--bg-color); color: var(--font-color);">
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                <button id="start-test-btn" style="padding: 0.6rem 1.2rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; background-color: var(--primary-color); color: white;">चेक करना शुरू करे</button>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="questions-data.js"></script>
   <script>
    // START: FIREBASE CONFIG (ADDED)
    const firebaseConfig = {
      apiKey: "AIzaSyCm3JQ_hvjhwpCZsHFYdgSr3Fudu-K1ezU",
      authDomain: "myexamanalyzer.firebaseapp.com",
       projectId: "myexamanalyzer",
   storageBucket: "myexamanalyzer.firebasestorage.app",
  messagingSenderId: "1001576173103",
           appId: "1:1001576173103:web:55b5052cb8169370c400da"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // END: FIREBASE CONFIG (ADDED)

    let currentShiftId = null, allQuestions = [], userAnswers = {}, currentSeries = '', activeFilter = 'all', currentShiftData = {};

    document.addEventListener('DOMContentLoaded', () => {

        // ======================= START: THEME SELECTOR JAVASCRIPT =======================
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        const themeSelector = document.querySelector('.theme-selector');
        const root = document.documentElement;
        const THEME_KEY = 'selected_theme_mps';

        if (themeToggleBtn) { 
            const applyTheme = (theme) => {
                if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    root.setAttribute('data-theme', prefersDark ? 'dark-blue' : 'light-blue');
                } else {
                    root.setAttribute('data-theme', theme);
                }
                localStorage.setItem(THEME_KEY, theme);
            };
            themeToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', () => {
                if (!themeDropdown.classList.contains('hidden')) {
                    themeDropdown.classList.add('hidden');
                }
            });
            themeDropdown.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const selectedTheme = e.target.dataset.theme;
                    applyTheme(selectedTheme);
                    themeDropdown.classList.add('hidden');
                }
            });
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme === 'auto') {
                    applyTheme('auto');
                }
            });
            const savedTheme = localStorage.getItem(THEME_KEY) || 'auto';
            applyTheme(savedTheme);
        }
        // ======================== END: THEME SELECTOR JAVASCRIPT ========================
        
        // --- लीडरबोर्ड के लिए नया कोड (UPDATED) ---
        const leaderboardShiftFilter = document.getElementById('leaderboard-shift-filter');
        const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const leaderboardTableContainer = document.getElementById('leaderboard-table-container');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const leaderboardLoading = document.getElementById('leaderboard-loading');

      async function fetchAndDisplayLeaderboard(shiftFilter = 'all') {
            if (!db) return;

            leaderboardLoading.style.display = 'block';
            leaderboardBody.innerHTML = '';
            let allUsers = [];

            try {
                const shiftsToFetch = shiftFilter === 'all' ?
                    ['shift1', 'shift2', 'shift3', 'shift4', 'shift5', 'shift6'] :
                    [shiftFilter];

                for (const shiftId of shiftsToFetch) {
                   const usersSnapshot = await db.collection('userResponses').doc(shiftId).collection('users').get({ source: 'server' });
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.summary && userData.summary.rawMarks) {
                            const correct = parseInt(userData.summary.correct) || 0;
                            const incorrect = parseInt(userData.summary.incorrect) || 0;
                            const skipped = parseInt(userData.summary.skipped) || 0;
                            const validQuestions = parseInt(userData.summary.validQuestions) || 0;

                            // ======================= START: REQUIRED CHANGE =======================
                            // यहाँ हमने यह सुनिश्चित किया है कि validQuestions 0 से ज़्यादा हो।
                            if (validQuestions > 0 && (correct + incorrect + skipped) === validQuestions) {
                                allUsers.push({
                                    name: userData.name || 'Not Provided',
                                    rawMarks: parseFloat(userData.summary.rawMarks) || 0,
                                    correct: correct,
                                    incorrect: incorrect,
                                    skipped: skipped,
                                    shift: shiftId
                                });
                            }
                            // ======================== END: REQUIRED CHANGE ========================
                        }
                    });
                }
                
                // उन यूजर्स को फ़िल्टर करें जिनके रॉ मार्क्स 180 या उससे कम हैं।
                const filteredUsers = allUsers.filter(user => user.rawMarks <= 180);

                // फ़िल्टर किए गए यूजर्स को रॉ मार्क्स के अनुसार Sort करें
                filteredUsers.sort((a, b) => b.rawMarks - a.rawMarks);

                // फ़िल्टर किए गए यूजर्स का उपयोग करके टेबल बनाएं
                leaderboardBody.innerHTML = filteredUsers.map((user, index) => `
    <tr style="border-bottom: 1px solid var(--border-color);">
        <td style="padding: 0.75rem;">${index + 1}</td>
        <td style="padding: 0.75rem;">${user.name}</td>
        <td style="padding: 0.75rem; font-weight: bold; color: black;">${user.rawMarks.toFixed(2)}</td>
        <td style="padding: 0.75rem; color: var(--success-color); font-weight: 500;">${user.correct}</td>
        <td style="padding: 0.75rem; color: var(--danger-color); font-weight: 500;">${user.incorrect}</td>
        <td style="padding: 0.75rem; color: blue; font-weight: 500;">${user.skipped}</td>
        <td style="padding: 0.75rem;">${user.shift.replace('shift', 'Shift ')}</td>
    </tr>
`).join('');

            } catch (error) {
                console.error("लीडरबोर्ड डेटा लाने में त्रुटि: ", error);
                leaderboardBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1rem; color: var(--danger-color);">डेटा लोड करने में त्रुटि हुई।</td></tr>';
            } finally {
                leaderboardLoading.style.display = 'none';
            }
        }
        
        if (viewLeaderboardBtn) {
            viewLeaderboardBtn.addEventListener('click', () => {
                leaderboardTableContainer.style.display = 'block';
                fetchAndDisplayLeaderboard(leaderboardShiftFilter.value);
                viewLeaderboardBtn.style.display = 'none';
            });
        }

        if (leaderboardShiftFilter) {
            leaderboardShiftFilter.addEventListener('change', () => {
                if (leaderboardTableContainer.style.display !== 'none') {
                    fetchAndDisplayLeaderboard(leaderboardShiftFilter.value);
                }
            });
        }
        // --- लीडरबोर्ड कोड का अंत ---

        if (typeof allShiftData === 'undefined') {
            document.body.innerHTML = '<h1 style="text-align:center; padding: 2rem; color: red;">Please Wait... Official उत्तर कुंजी अपडेट की जा रही है।</h1>';
            return;
        }

        const shiftSelectorPage = document.getElementById('shift-selector-page');
        const questionPaperPage = document.getElementById('question-paper-page');
        const seriesSelect = document.getElementById('series-select');
        const printBtn = document.getElementById('header-print-btn');
        const pMO = document.getElementById('print-modal-overlay');
        const toggleInfoBtn = document.getElementById('toggle-info-bar-btn');
        const resetBtn = document.getElementById('reset-answers-btn');
        const questionsContainer = document.getElementById('questions-container');

        // --- START: LOGIC FOR NEW USER INFO MODAL ---
        const startTestBtn = document.getElementById('start-test-btn');
        if (startTestBtn) {
            startTestBtn.addEventListener('click', () => {
                const nameInput = document.getElementById('initial-student-name');
                const rollInput = document.getElementById('initial-student-roll');

                if (!nameInput.value.trim() || !rollInput.value.trim()) {
                    alert("नाम और रोल नंबर दोनों आवश्यक हैं।");
                    return;
                }

                // Save to localStorage
                localStorage.setItem('studentName_mps', nameInput.value.trim());
                localStorage.setItem('studentRoll_mps', rollInput.value.trim());

                // Now load the paper
                proceedToLoadPaper(currentShiftId, true);
            });
        }
        // --- END: LOGIC FOR NEW USER INFO MODAL ---

        function showHomePage() {
            shiftSelectorPage.style.display = 'flex';
            questionPaperPage.style.display = 'none';
            if(themeSelector) themeSelector.style.display = 'block';
            currentShiftId = null;
            history.pushState({page: 'home'}, 'Home', window.location.pathname);
            window.location.hash = '';
        }

        window.addEventListener('popstate', (event) => {
            if (!event.state || event.state.page === 'home') {
                showHomePage();
            } else if (event.state.shift) {
                loadShift(event.state.shift, false);
            }
        });

        document.querySelectorAll('.shift-btn').forEach(b => b.addEventListener('click', (e) => {
            e.preventDefault();
            loadShift(b.dataset.shift, true);
        }));

        // ======================= START: MODIFIED loadShift LOGIC =======================
        function loadShift(shiftId, shouldPushState = true) {
            currentShiftId = shiftId; // Set shiftId immediately

            // Check if name and roll are already in localStorage
            const savedName = localStorage.getItem('studentName_mps');
            const savedRoll = localStorage.getItem('studentRoll_mps');

            if (!savedName || !savedRoll) {
                // If not found, show the new info modal
                document.getElementById('initial-student-name').value = savedName || '';
                document.getElementById('initial-student-roll').value = savedRoll || '';
                document.getElementById('user-info-modal-overlay').style.display = 'flex';
            } else {
                // If found, proceed to load the paper directly
                proceedToLoadPaper(shiftId, shouldPushState);
            }
        }

        function proceedToLoadPaper(shiftId, shouldPushState = true) {
            document.getElementById('user-info-modal-overlay').style.display = 'none';
            shiftSelectorPage.style.display = 'none';
            questionPaperPage.style.display = 'flex';
            if(themeSelector) themeSelector.style.display = 'none';

            currentShiftData = allShiftData[shiftId];
            allQuestions = currentShiftData.questions;
            
            document.getElementById('shift-title').textContent = currentShiftData.title;

            seriesSelect.innerHTML = '';
            const availableSeries = Object.keys(currentShiftData.seriesOrder || {});
            if (availableSeries.length > 0) {
                availableSeries.forEach(seriesKey => {
                    const option = document.createElement('option');
                    option.value = seriesKey;
                    option.textContent = seriesKey;
                    seriesSelect.appendChild(option);
                });
            }

            userAnswers = JSON.parse(localStorage.getItem(`userAnswers_${shiftId}`)) || {};
            
            const savedSeries = localStorage.getItem(`currentSeries_${shiftId}`);
            currentSeries = (savedSeries && availableSeries.includes(savedSeries)) ? savedSeries : availableSeries[0] || '';
            seriesSelect.value = currentSeries;

            activeFilter = 'all';
            document.getElementById('toggle-summary-btn').textContent = 'Show Result';
            document.querySelector('.summary-bar').classList.add('hidden');
            
            if (shouldPushState) {
               history.pushState({ shift: shiftId }, '', `#${shiftId}`);
            }
            displayQuestions(currentSeries, activeFilter);
        }
        // ======================= END: MODIFIED loadShift LOGIC =======================

        function saveData() {
            if (!currentShiftId) return;
            localStorage.setItem(`userAnswers_${currentShiftId}`, JSON.stringify(userAnswers));
            localStorage.setItem(`currentSeries_${currentShiftId}`, currentSeries);
        }

        // ======================= START: MODIFIED Firebase FUNCTION =======================
        function sendAnswerToFirebase(userId) {
            if (!currentShiftId || !db) return;

            const summaryData = {
                correct: document.getElementById('correct-count').textContent,
                incorrect: document.getElementById('incorrect-count').textContent,
                skipped: document.getElementById('skipped-count').textContent,
                attempted: document.getElementById('attempted-count').textContent,
                finalRQ: document.getElementById('right-que-value').textContent,
                rawMarks: document.getElementById('raw-marks-value').textContent,
                validQuestions: document.getElementById('total-count').textContent
            };
            
            // MODIFIED: Always get name/roll from localStorage for reliability, especially on page exit.
            const finalName = localStorage.getItem('studentName_mps') || 'Not Provided';
            const finalRollNo = localStorage.getItem('studentRoll_mps') || 'Not Provided';

            db.collection('userResponses')
              .doc(currentShiftId)
              .collection('users')
              .doc(userId)
              .set({
                  summary: summaryData,
                  series: currentSeries,
                  rollNo: finalRollNo,
                  name: finalName,
                  lastUpdated: new Date()
              }, { merge: true })
              .then(() => {
                  console.log(`Data for User: ${userId} successfully saved to Firebase!`);
              })
              .catch((error) => {
                  console.error("Firebase Error: ", error);
              });
        }
        // ======================= END: MODIFIED Firebase FUNCTION =======================

        function getQuestionStatus(qId) {
            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return 'unattempted';
            if (qData.deleted) return 'deleted';
            
            const uAnsText = userAnswers[qId];
            if (!uAnsText) return 'unattempted';
            if (uAnsText === "अनुत्तरित प्रश्न" || uAnsText === "Question not attempted") return 'skipped';
            
            const correctAnswerText = qData.answer.substring(3);
            return uAnsText === correctAnswerText ? 'correct' : 'incorrect';
        }

        function updateSummary() {
            let c = 0, i = 0, s = 0, d = 0, attemptedForDeleted = 0;
            allQuestions.forEach(q => {
                const status = getQuestionStatus(q.id);
                if (q.deleted) {
                     d++;
                     if (userAnswers[q.id]) attemptedForDeleted++;
                     return;
                }
                if (status === 'correct') c++;
                else if (status === 'incorrect') i++;
                else if (status === 'skipped') s++;
            });
            
            const a = c + i + attemptedForDeleted;
            const totalValidQuestions = allQuestions.length - d;
            
            const unattempted = totalValidQuestions - (c + i + s);
            const warningBox = document.getElementById('unattempted-warning-item');
            if (warningBox) {
                if (unattempted > 0) {
                    document.getElementById('unattempted-count').textContent = unattempted;
                    warningBox.classList.add('visible');
                } else {
                    warningBox.classList.remove('visible');
                }
            }

            document.getElementById('total-count').textContent = totalValidQuestions;
            document.getElementById('attempted-count').textContent = a;
            document.getElementById('correct-count').textContent = c;
            document.getElementById('incorrect-count').textContent = i;
            document.getElementById('skipped-count').textContent = s;
            document.getElementById('deleted-count').textContent = d;
            
            const rQ = c - (i / 3);
            let rM = (totalValidQuestions > 0) ? rQ * (200 / totalValidQuestions) : 0;
            
            document.getElementById('right-que-value').textContent = (rQ % 1 === 0) ? rQ : rQ.toFixed(2);
            document.getElementById('raw-marks-value').textContent = rM.toFixed(2);
        }
        
        function findQuestionPositions(qId) {
            const qIndex = allQuestions.findIndex(q => q.id === qId);
            if (qIndex === -1 || !currentShiftData.seriesOrder) return `Q ID: ${qId}`;

            const positions = [];
            for (const series in currentShiftData.seriesOrder) {
                const pos = currentShiftData.seriesOrder[series].indexOf(qIndex + 1);
                if (pos !== -1) {
                    positions.push(`<strong>${series}:</strong> #${pos + 1}`);
                }
            }
            return positions.length > 0 ? positions.join(' | ') : `Q ID: ${qId}`;
        }

        function displayQuestions(series, filter = 'all') {
            questionsContainer.innerHTML = '';
            currentSeries = series;
            updateSummary();
            updateActiveFilterButton(filter);

            const seriesOrder = currentShiftData.seriesOrder || {};
            const qIndices = seriesOrder[series] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            
            const optionLabels = ['A)', 'B)', 'C)', 'D)', 'E)'];
            const OPTION_LENGTH_THRESHOLD = 40; 

            qIndices.forEach((qIndex, displayNum) => {
                const qData = allQuestions[qIndex - 1];
                if (!qData) return;

                const isDeleted = qData.deleted === true;
                const status = getQuestionStatus(qData.id);
                const finalStatusForFilter = isDeleted ? (userAnswers[qData.id] ? 'deleted' : 'unattempted') : status;

                if (filter !== 'all' && filter !== finalStatusForFilter) return;
                
                const qB = document.createElement('div');
                qB.className = 'question-block';
                qB.dataset.questionId = qData.id;
                 if (isDeleted) {
                    qB.style.backgroundColor = '#f1f3f5';
                }
                
                const iB = document.createElement('div');
                iB.className = 'question-info-bar';
                iB.innerHTML = findQuestionPositions(qData.id);
                qB.appendChild(iB);
                
                const qContent = document.createElement('div');
                qContent.className = 'question-content';

                const qT = document.createElement('h3');
                qT.innerHTML = `<span class="print-q-num">प्रश्न ${displayNum + 1}: </span> ${qData.question}`;
                qContent.appendChild(qT);
                
                if (qData.image) {
                    const qImg = document.createElement('img');
                    qImg.src = qData.image;
                    qImg.alt = "प्रश्न चित्र";
                    qContent.appendChild(qImg);
                }
                qB.appendChild(qContent);

                const oCont = document.createElement('div');
                oCont.className = 'options-container';
                
                const oL = document.createElement('ul');
                oL.className = 'options-list';

                const optionsAreShort = qData.options.slice(0, 4).every(opt => opt.length < OPTION_LENGTH_THRESHOLD);
                if (optionsAreShort && qData.options.length >= 4) {
                    oL.classList.add('options-grid');
                }
                
                const optionTexts = qData.options.map(opt => opt.substring(3));
                
                let shuffledOptionTexts;
                const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[series];

                if (Array.isArray(seriesOptionConfig)) {
                    shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
                } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                    const specificOrder = seriesOptionConfig[qData.id];
                    const defaultOrder = seriesOptionConfig['default'];
                    const orderToUse = specificOrder || defaultOrder;
                    shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
                } else {
                    shuffledOptionTexts = [...optionTexts];
                }
                
                shuffledOptionTexts.forEach((text, index) => {
                    const oI = document.createElement('li');
                    oI.innerHTML = `${optionLabels[index]} ${text}`;
                    oI.dataset.rawText = text.trim();
                    oL.appendChild(oI);
                });
                oCont.appendChild(oL);
                qB.appendChild(oCont);
                questionsContainer.appendChild(qB);
                
                updateQuestionUI(qData.id);
            });

            if (questionsContainer.innerHTML === '') {
                questionsContainer.innerHTML = `<p style="text-align:center; color: var(--font-color-light); padding: 2rem;">इस फ़िल्टर में कोई प्रश्न नहीं है।</p>`;
            }
            
            if (window.MathJax) {
                MathJax.typesetPromise([questionsContainer]).catch(function (err) {
                    console.log('MathJax error: ', err);
                });
            }
        }
        
        function updateQuestionUI(qId) {
            const qBlock = document.querySelector(`.question-block[data-question-id='${qId}']`);
            if (!qBlock) return;

            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return;

            const status = getQuestionStatus(qId);
            const isDeleted = qData.deleted === true;
            const optionsList = qBlock.querySelector('.options-list');
            const optionsContainer = qBlock.querySelector('.options-container');
            let answerDisplay = qBlock.querySelector('.correct-answer-display');

            optionsList.querySelectorAll('li').forEach(li => {
                li.classList.remove('correct', 'incorrect', 'special', 'selected-neutral');
            });

            const userAnswerText = userAnswers[qId];
            if (userAnswerText) {
                const selectedLi = Array.from(optionsList.querySelectorAll('li')).find(li => li.dataset.rawText === userAnswerText);
                if (selectedLi) {
                    if (isDeleted) {
                        selectedLi.classList.add('selected-neutral');
                    } else if (status === 'correct') selectedLi.classList.add('correct');
                    else if (status === 'incorrect') selectedLi.classList.add('incorrect');
                    else if (status === 'skipped') selectedLi.classList.add('special');
                }
            }

            if (answerDisplay) answerDisplay.remove();

            if (isDeleted) {
                answerDisplay = document.createElement('div');
                answerDisplay.className = 'correct-answer-display';
                answerDisplay.innerHTML = 'Status: <strong style="color: var(--danger-color);">Deleted</strong>';
                optionsContainer.appendChild(answerDisplay);
            } else if (status !== 'unattempted') {
                answerDisplay = document.createElement('div');
                answerDisplay.className = 'correct-answer-display';
                
                const optionLabels = ['A)', 'B)', 'C)', 'D)', 'E)'];
                const optionTexts = qData.options.map(opt => opt.substring(3));
                
                let shuffledOptionTexts;
                const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[currentSeries];
                if (Array.isArray(seriesOptionConfig)) {
                    shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
                } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                    const specificOrder = seriesOptionConfig[qData.id];
                    const defaultOrder = seriesOptionConfig['default'];
                    const orderToUse = specificOrder || defaultOrder;
                    shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
                } else {
                    shuffledOptionTexts = [...optionTexts];
                }

                const correctAnswerText = qData.answer.substring(3);
                const newCorrectIndex = shuffledOptionTexts.indexOf(correctAnswerText);
                let dynamicCorrectAnswer = qData.answer;
                if (newCorrectIndex !== -1) {
                     dynamicCorrectAnswer = `${optionLabels[newCorrectIndex]} ${correctAnswerText}`;
                }
                
                answerDisplay.innerHTML = `Correct Ans: <strong style="color: var(--success-color);">${dynamicCorrectAnswer}</strong>`;
                optionsContainer.appendChild(answerDisplay);
            }
        }
   
        questionsContainer.addEventListener('click', (e) => {
            const clickedLi = e.target.closest('li');
            if (!clickedLi) return;

            const questionBlock = e.target.closest('.question-block');
            if (!questionBlock) return;

            const qId = parseInt(questionBlock.dataset.questionId);
            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return;

            userAnswers[qId] = clickedLi.dataset.rawText;
            
            saveData(); 
            updateQuestionUI(qId);
            updateSummary(); 

            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (!userId) {
                userId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(`userId_${currentShiftId}`, userId);
            }
        
            const isDeleted = qData.deleted === true;
            const newStatus = getQuestionStatus(qId);
            const finalStatusForFilter = isDeleted ? (userAnswers[qId] ? 'deleted' : 'unattempted') : newStatus;

            if (activeFilter !== 'all' && activeFilter !== finalStatusForFilter) {
                setTimeout(() => { questionBlock.style.display = 'none'; }, 200);
            }
        });
   
       // ================= START: EXIT SAVE CODE (NEW) =================
        // पेज बंद होने पर डेटा बचाने के लिए यह अंतिम और सबसे सरल कोड है।

        function finalSaveOnExit() {
            // यह सुनिश्चित करें कि currentShiftId और userId मौजूद हैं
            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (!userId || !currentShiftId) {
                console.log("Exit Save: उपयोगकर्ता की जानकारी नहीं मिली, सेव नहीं किया जा रहा है।");
                return; // अगर जानकारी नहीं है तो बाहर निकलें
            }

            console.log("पेज बंद हो रहा है, अंतिम डेटा सहेजने का प्रयास किया जा रहा है...");
            
            // 1. सबसे महत्वपूर्ण: स्क्रीन पर नवीनतम स्कोर की गणना करें
            // ताकि sendAnswerToFirebase फ़ंक्शन सही डेटा पढ़े
            updateSummary();
            
            // 2. अब Firebase पर डेटा भेजें (वही फ़ंक्शन जो प्रिंट बटन करता है)
            sendAnswerToFirebase(userId);
        }

        // 'pagehide' इवेंट का उपयोग करें, यह पेज से बाहर निकलने के लिए सबसे विश्वसनीय इवेंट है।
        window.addEventListener('pagehide', finalSaveOnExit);

        // ================== END: EXIT SAVE CODE (NEW) ==================
           
        function updateActiveFilterButton(filter) {
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-buttons button[data-filter="${filter}"]`).classList.add('active');
        }

        seriesSelect.addEventListener('change', (e) => {
            displayQuestions(e.target.value, activeFilter);
            saveData();
        });
        
        resetBtn.addEventListener('click', () => {
            if (confirm("क्या आप वाकई इस पेपर के लिए अपने सभी उत्तर हटाना चाहते हैं?")) {
                userAnswers = {};
                saveData();
                let userId = localStorage.getItem(`userId_${currentShiftId}`);
                if (userId) {
                    sendAnswerToFirebase(userId);
                }
                displayQuestions(currentSeries, 'all');
            }
        });

        document.querySelectorAll('.filter-buttons button').forEach(b => b.addEventListener('click', () => {
            activeFilter = b.dataset.filter;
            displayQuestions(currentSeries, activeFilter);
        }));

        document.getElementById('toggle-summary-btn').addEventListener('click', (e) => {
            const sB = document.querySelector('.summary-bar');
            sB.classList.toggle('hidden');
            e.target.textContent = sB.classList.contains('hidden') ? 'Show Result' : 'Hide Result';
        });
        
        toggleInfoBtn.addEventListener('click', () => {
            const icon = toggleInfoBtn.querySelector('i');
            questionPaperPage.classList.toggle('hide-q-info');
            if(questionPaperPage.classList.contains('hide-q-info')) {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        function populatePrintHeader(name, rollNo){
            document.getElementById('print-title').textContent = document.getElementById('shift-title').textContent;
            document.getElementById('print-name').textContent = name;
            document.getElementById('print-roll').textContent = rollNo;
            document.getElementById('print-series').textContent = seriesSelect.value;
            document.getElementById('print-full-total').textContent = allQuestions.length;
            document.getElementById('print-valid-total').textContent = document.getElementById('total-count').textContent;
            document.getElementById('print-attempted').textContent = document.getElementById('attempted-count').textContent;
            document.getElementById('print-correct-cell').textContent = document.getElementById('correct-count').textContent;
            document.getElementById('print-incorrect-cell').textContent = document.getElementById('incorrect-count').textContent;
            document.getElementById('print-skipped').textContent = document.getElementById('skipped-count').textContent;
            document.getElementById('print-deleted').textContent = document.getElementById('deleted-count').textContent;
            document.getElementById('print-final-rq-display').textContent = document.getElementById('right-que-value').textContent;
            document.getElementById('print-raw-marks-display').textContent = document.getElementById('raw-marks-value').textContent;
        }

        function openPrintWindow(content, bodyClass = '') {
            const oldFrame = document.getElementById('printf');
            if (oldFrame) { oldFrame.remove(); }

            const printFrame = document.createElement('iframe');
            printFrame.id = 'printf';
            printFrame.style.position = 'absolute';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            printFrame.style.left = '-9999px';
            document.body.appendChild(printFrame);

            const styles = document.getElementById('main-styles').innerHTML;
            const fontLink = `<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">`;
            const mathJaxScript = `<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>`;
            const mathJaxConfig = `<script>MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };<\/script>`;
            const printLogic = `
                <script>
                    (() => {
                        let hasPrinted = false;
                        const triggerPrint = () => {
                            if (hasPrinted) return;
                            hasPrinted = true;
                            try {
                                window.focus(); window.print();
                            } catch (e) { console.error("Print failed:", e); } 
                            finally {
                                setTimeout(() => {
                                    const frame = parent.document.getElementById('printf');
                                    if (frame) frame.remove();
                                }, 1000);
                            }
                        };
                        const runPrintProcess = () => {
                            const mathJaxPromise = (typeof MathJax !== 'undefined' && MathJax.typesetPromise)
                                ? MathJax.startup.promise.then(() => MathJax.typesetPromise())
                                : Promise.resolve();
                            const imagePromises = [...document.querySelectorAll('img')].map(img => {
                                if (img.complete) return Promise.resolve();
                                return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                            });
                            Promise.all([mathJaxPromise, ...imagePromises])
                                .then(() => { triggerPrint(); })
                                .catch(err => { console.error('Pre-print error:', err); triggerPrint(); });
                            setTimeout(triggerPrint, 8000);
                        };
                        window.addEventListener('load', runPrintProcess);
                    })();
                <\/script>
            `;
            const frameContent = `
                <html><head><title>Print</title>${fontLink}<style>${styles}</style>${mathJaxConfig}${mathJaxScript}</head>
                <body class="${bodyClass} ${questionPaperPage.classList.contains('hide-q-info') ? 'hide-q-info' : ''}">
                    ${content}${printLogic}</body></html>`;

            printFrame.contentDocument.open();
            printFrame.contentDocument.write(frameContent);
            printFrame.contentDocument.close();
        }

        function getCorrectOptionForSeries(qData, series) {
            if (qData.deleted) return 'Delete';
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];
            const correctAnswerText = qData.answer.substring(3);
            const optionTexts = qData.options.map(opt => opt.substring(3));
            
            let shuffledOptionTexts;
            const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[series];
            if (Array.isArray(seriesOptionConfig)) {
                shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
            } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                const specificOrder = seriesOptionConfig[qData.id];
                const defaultOrder = seriesOptionConfig['default'];
                const orderToUse = specificOrder || defaultOrder;
                shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
            } else {
                shuffledOptionTexts = [...optionTexts];
            }
            
            const newCorrectIndex = shuffledOptionTexts.indexOf(correctAnswerText);
            return (newCorrectIndex !== -1) ? optionLabels[newCorrectIndex] : '?';
        }

        function generateAndPrintOfficialKey() {
            const container = document.getElementById('official-key-print-container');
            let html = `<div class="official-key-header">
                    <h1>चतुर्थ श्रेणी कर्मचारी संभावित उत्तर कुंजी</h1>
                    <p>${currentShiftData.title} | पेपर कोड: ${currentSeries}</p>
                </div><div class="official-key-grid">`;

            const seriesOrder = currentShiftData.seriesOrder[currentSeries] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            const totalQuestions = seriesOrder.length;
            const questionsPerColumn = 30;
            const numColumns = Math.ceil(totalQuestions / questionsPerColumn);
            
            for (let c = 0; c < numColumns; c++) {
                html += `<div class="official-key-column"><table class="official-key-table"><thead><tr><th>प्रश्न</th><th>उत्तर</th></tr></thead><tbody>`;
                const start = c * questionsPerColumn;
                const end = Math.min(start + questionsPerColumn, totalQuestions);
                for (let i = start; i < end; i++) {
                    const displayNum = i + 1;
                    const qIndex = seriesOrder[i];
                    const qData = allQuestions[qIndex - 1];
                    if(qData) {
                        const correctOpt = getCorrectOptionForSeries(qData, currentSeries);
                        html += `<tr><td>${displayNum}</td><td>${correctOpt}</td></tr>`;
                    }
                }
                html += `</tbody></table></div>`;
            }

            html += `</div>`;
            html += `<div class="official-key-footer"><p>नोट - यह अभी संभावित उत्तर कुंजी है, बोर्ड द्वारा Official उत्तर कुंजी जारी होने पर UPDATE कर दी जाएगी </p></div>`;

            container.innerHTML = html;
            openPrintWindow(container.innerHTML);
        }

        function generateAndPrintOMR(name, rollNo) {
            populatePrintHeader(name, rollNo); 
            const container = document.getElementById('omr-print-container');
            container.innerHTML = ''; 

            const headerSource = document.getElementById('print-fallback-details');
            container.appendChild(headerSource.cloneNode(true));
            
            const grid = document.createElement('div');
            grid.className = 'omr-grid';
            
            const seriesOrder = currentShiftData.seriesOrder[currentSeries] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            const totalQuestions = seriesOrder.length;
            const questionsPerColumn = Math.ceil(totalQuestions / 4);
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];

            for (let c = 0; c < 4; c++) {
                const column = document.createElement('div');
                column.className = 'omr-column';
                const start = c * questionsPerColumn;
                const end = Math.min(start + questionsPerColumn, totalQuestions);

                for (let i = start; i < end; i++) {
                    const displayNum = i + 1;
                    const qIndex = seriesOrder[i];
                    if (!allQuestions[qIndex - 1]) continue;
                    const qData = allQuestions[qIndex - 1];
                    
                    const status = getQuestionStatus(qData.id);
                    const isDeleted = qData.deleted === true;

                    const row = document.createElement('div');
                    row.className = 'omr-row';
                    
                    const qNumDiv = document.createElement('div');
                    qNumDiv.className = 'omr-q-num';
                    qNumDiv.textContent = `${displayNum}.`;
                    
                    if (isDeleted) {
                        row.style.opacity = '0.7';
                    } else if (status === 'incorrect') {
                        qNumDiv.style.color = 'red';
                    } else if (status === 'skipped') {
                        qNumDiv.style.color = 'blue';
                    }
                    row.appendChild(qNumDiv);
                    
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'omr-options';
                    
                    const userAnswerText = userAnswers[qData.id];
                    let filledOptionIndex = -1;

                    if (userAnswerText) {
                        const originalOptionTexts = qData.options.map(opt => opt.substring(3));
                        let shuffledOptionTexts;
                        const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[currentSeries];
                         if (Array.isArray(seriesOptionConfig)) {
                            shuffledOptionTexts = seriesOptionConfig.map(index => originalOptionTexts[index]);
                        } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                            const specificOrder = seriesOptionConfig[qData.id];
                            const defaultOrder = seriesOptionConfig['default'];
                            const orderToUse = specificOrder || defaultOrder;
                            shuffledOptionTexts = orderToUse ? orderToUse.map(index => originalOptionTexts[index]) : [...originalOptionTexts];
                        } else {
                            shuffledOptionTexts = [...originalOptionTexts];
                        }

                        const userAnsIndex = shuffledOptionTexts.findIndex(txt => txt.trim() === userAnswerText.trim());
                        if(userAnsIndex !== -1) filledOptionIndex = userAnsIndex;
                    }

                    optionLabels.forEach((label, index) => {
                         const bubble = document.createElement('div');
                         bubble.className = 'omr-bubble';
                         bubble.textContent = label;
                         if (index === filledOptionIndex) {
                            if(isDeleted) {
                                bubble.classList.add('filled-neutral');
                            } else {
                                bubble.classList.add('filled');
                            }
                         }
                         optionsDiv.appendChild(bubble);
                    });

                    row.appendChild(optionsDiv);
                    column.appendChild(row);
                }
                grid.appendChild(column);
            }
            container.appendChild(grid);
            
            openPrintWindow(container.innerHTML, 'omr-print-body');
        }

        function triggerPaperPrint(name, rollNo) {
            populatePrintHeader(name, rollNo); 
            const headerHTML = document.getElementById('print-fallback-details').outerHTML;
            const questionsHTML = document.getElementById('questions-container').outerHTML;
            openPrintWindow(headerHTML + questionsHTML);
        }

        printBtn.addEventListener('click', () => { 
            const savedName = localStorage.getItem('studentName_mps');
            const savedRoll = localStorage.getItem('studentRoll_mps');
            if (savedName) document.getElementById('student-name').value = savedName;
            if (savedRoll) document.getElementById('student-roll').value = savedRoll;
            pMO.style.display = 'flex'; 
        });

        document.getElementById('cancel-print').addEventListener('click', () => { pMO.style.display = 'none'; })
            // START: Auto-save name/roll from print popup on input change
        document.getElementById('student-name').addEventListener('input', (e) => {
            localStorage.setItem('studentName_mps', e.target.value.trim());
        });
        document.getElementById('student-roll').addEventListener('input', (e) => {
            localStorage.setItem('studentRoll_mps', e.target.value.trim());
        });
        // END: Auto-save logic
        
        document.getElementById('confirm-print').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if (!name || !rollNo) { alert("नाम और रोल नंबर दोनों आवश्यक हैं।"); return; }
            
            localStorage.setItem('studentName_mps', name);
            localStorage.setItem('studentRoll_mps', rollNo);
            
            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (userId) sendAnswerToFirebase(userId);

            pMO.style.display = 'none';
            triggerPaperPrint(name, rollNo);
        });

        document.getElementById('get-omr-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if (!name || !rollNo) { alert("नाम और रोल नंबर दोनों आवश्यक हैं।"); return; }

            localStorage.setItem('studentName_mps', name);
            localStorage.setItem('studentRoll_mps', rollNo);

            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (userId) sendAnswerToFirebase(userId);

            pMO.style.display = 'none';
            generateAndPrintOMR(name, rollNo);
        });
        document.getElementById('get-official-key-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if(name) localStorage.setItem('studentName_mps', name);
            if(rollNo) localStorage.setItem('studentRoll_mps', rollNo);
             pMO.style.display = 'none';
             generateAndPrintOfficialKey();
        });

        const shiftIdFromUrl = window.location.hash.substring(1);
        if (shiftIdFromUrl && allShiftData[shiftIdFromUrl]) {
            loadShift(shiftIdFromUrl);
        } else {
            showHomePage();
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => { console.log('ServiceWorker registration successful'); })
                .catch(error => { console.log('ServiceWorker registration failed: ', error); });
        });
    }
</script>
</body>
</html>
