<!DOCTYPE html>
<html lang="hi">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4th Grade Paper Analysis by MP SALODIYA</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style id="main-styles">
        :root {
            --primary-color: #0d6efd;
            --primary-dark: #0b5ed7;
            --primary-light: #cfe2ff;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --font-color: #212529;
            --font-color-light: #6c757d;
            --border-color: #dee2e6;
            
            --success-bg: #d1e7dd;
            --danger-bg: #f8d7da;
            --special-bg: #fff3cd;
            --subtle-bg: #f1f3f5;

            --font-family-primary: 'Noto Sans Devanagari', sans-serif;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 0.5rem;
        }

        * { box-sizing: border-box; }

        html { font-size: 16px; }

        body {
            font-family: var(--font-family-primary);
            background-color: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            line-height: 1.6;
        }
        
        #shift-selector-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .selector-container {
            width: 100%;
            padding: 1rem;
            text-align: center;
        }
        .selector-container h2 {
            font-size: 2.75rem; /* हेडिंग को थोड़ा बड़ा किया */
            font-weight: 900; /* और ज़्यादा बोल्ड किया */
            margin: 0 0 0.5rem;
            
            /* यह टेक्स्ट को रंगीन ग्रेडिएंट बनाता है */
            background: linear-gradient(90deg, 
                var(--primary-color), /* नीला */
                #9b59b6, /* बैंगनी */
                var(--success-color), /* हरा */
                var(--primary-color) /* वापस नीला */
            );
            background-size: 200% auto; /* एनीमेशन के लिए साइज़ दोगुना */
            
            /* यह बैकग्राउंड को टेक्स्ट के आकार में काटता है */
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; /* टेक्स्ट का अपना रंग हटाता है */
            
            /* एनीमेशन लागू करता है */
            animation: text-gradient-flow 5s linear infinite;
        }
        .selector-container .subtitle { font-size: 1.1rem; color: var(--font-color-light); margin-bottom: 3rem; }
        .shift-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
    .shift-btn {
    display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1.25rem;
    background-color: var(--surface-color); border: 1px solid var(--border-color);
    border-radius: 50px;
    text-decoration: none; cursor: pointer;
    text-align: left; box-shadow: var(--shadow-sm);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s;
    position: relative; /* <-- यह लाइन जोड़ें */
    overflow: hidden;   /* <-- और यह लाइन जोड़ें */
}
        }
        .shift-btn:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .shift-btn .icon {
            font-size: 1.5rem; color: var(--primary-color); width: 45px; height: 45px;
            display: grid; place-items: center; background-color: var(--primary-light);
            border-radius: 50%; flex-shrink: 0;
            transition: color 0.2s, background-color 0.2s;
        }
        .shift-btn .text { font-size: 1.1rem; font-weight: 600; color: var(--font-color); transition: color 0.2s; }
        .selector-footer { margin-top: 3rem; font-size: 0.875rem; color: var(--secondary-color); line-height: 1.5; }
        .selector-footer p { margin: 0.5rem 0; }
        
        .features-box {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-light);
            border-left: 5px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: left;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.2s, border-color 0.2s;
        }
        .features-box h4 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: color 0.2s, border-color 0.2s;
        }
        .features-box ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        .features-box li {
            position: relative;
            padding-left: 1.75rem;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        .features-box li::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--success-color);
            position: absolute;
            left: 0;
            top: 2px;
            font-size: 1.1rem;
            transition: color 0.2s;
        }
        .creator-link {
            color: var(--font-color);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.2s;
        }
        .creator-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        #question-paper-page { display: none; flex-direction: column; }
        
        .top-sticky-bar {
            position: sticky; top: 0; z-index: 1000; background-color: var(--surface-color);
            box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s, border-color 0.2s;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; flex-wrap: wrap; gap: 1rem;
        }
        .header h1 {
            font-size: 1.25rem; font-weight: 600; margin: 0; flex-grow: 1;
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #toggle-info-bar-btn {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--secondary-color);
            margin: 0 1rem 0 -2rem;
        }
        #reset-answers-btn {
            background: none; border: none; font-size: 1.1rem; cursor: pointer; color: var(--secondary-color);
            margin: 0 1rem;
        }
        .header-controls { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
        .header-controls label { font-size: 0.875rem; font-weight: 500; }
        .header-controls select, .header-controls button {
            padding: 0.5rem 0.85rem; border-radius: 0.375rem; border: 1px solid var(--border-color);
            background-color: #fff; font-family: inherit; font-size: 0.9rem; cursor: pointer;
        }
        #toggle-summary-btn {
            background-color: var(--primary-light); color: var(--primary-dark);
            border-color: var(--primary-light); font-weight: 600;
        }
        #header-print-btn { background-color: var(--success-color); color: white; border: none; transition: background-color 0.2s; }
        #header-print-btn:hover { background-color: #157347; }

        .summary-bar {
            padding: 1rem 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 1rem; border-top: 1px solid var(--border-color); background-color: #fdfdff; transition: all 0.3s ease;
        }
        .summary-bar.hidden { display: none; }
        .summary-item { text-align: center; padding: 0.5rem; border-radius: var(--border-radius); }
        .summary-item .count { font-size: 1.6rem; font-weight: 700; line-height: 1.2; }
        .summary-item .label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; opacity: 0.8; }
        
        #total-item { background-color: #e9ecef; color: #343a40; }
        #attempted-item { background-color: var(--primary-light); color: var(--primary-dark); }
        #correct-item { background-color: var(--success-bg); color: var(--success-color); }
        #incorrect-item { background-color: var(--danger-bg); color: var(--danger-color); }
        #skipped-item { background-color: var(--special-bg); color: #856404; }
        #deleted-item { background-color: #e9ecef; color: #495057; }
        #right-que-item { background-color: #d1e7dd; color: #0f5132; }
        #raw-marks-item { background-color: #cfe2ff; color: #0a58ca; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }

        .controls-bar {
            padding: 0.75rem; background-color: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); margin-bottom: 2rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .filter-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
        .filter-buttons button {
            background: none; border: 1px solid var(--border-color); border-radius: 2rem;
            padding: 0.5rem 1.25rem; cursor: pointer; transition: all 0.2s;
            font-family: inherit; font-weight: 500;
        }
        .filter-buttons button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        .question-block {
            background-color: var(--surface-color); margin-bottom: 1.5rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); transition: box-shadow 0.2s ease, background-color 0.2s; overflow: hidden;
        }
        .question-block:hover { box-shadow: var(--shadow-sm); }
        
        .question-info-bar { font-size: 0.8rem; color: var(--font-color-light); padding: 0.5rem 1.5rem; background-color: var(--subtle-bg); transition: background-color 0.2s, color 0.2s; }
        .question-content { padding: 1.5rem; }
        .question-content h3 { margin: 0 0 1.25rem 0; font-size: 1.2rem; font-weight: 600; line-height: 1.5; }
        .question-content img {
            max-width: 100%; height: auto; display: block; margin: 1rem auto;
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
        }

        .options-container { background-color: var(--subtle-bg); padding: 1.5rem; transition: background-color 0.2s; }
        .options-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .options-grid li:last-child:nth-child(5) { grid-column: 1 / -1; }

        .options-list li {
            border: 1px solid var(--border-color); background-color: var(--surface-color);
            padding: 0.85rem 1.1rem; border-radius: 0.375rem; cursor: pointer;
            transition: all 0.2s ease; position: relative;
        }
        .options-list li:hover { border-color: var(--primary-color); background-color: #f8fbff; }
        .options-list li.correct { background-color: var(--success-bg); border-color: var(--success-color); }
        .options-list li.incorrect { background-color: var(--danger-bg); border-color: var(--danger-color); }
        .options-list li.special { background-color: var(--special-bg); border-color: var(--warning-color); }
        .options-list li.selected-neutral {
            border-color: #333;
            background-color: #e9ecef;
            font-weight: 600;
        }
        
        .correct-answer-display { margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-weight: 600; }
        
        #print-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
            z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem;
        }
        #print-modal {
            background: white; padding: 2rem; border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
        }
        #print-modal h2 { margin-top: 0; }
        #print-modal p { margin: 0 0 1.5rem 0; color: var(--font-color-light); }
        #print-modal label { margin: 0 0 0.5rem 0; display: block; font-weight: 500;}
        #print-modal input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: 0.375rem; font-size: 1rem; font-family: inherit; margin-bottom: 1rem;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .modal-buttons button {
            padding: 0.6rem 1.2rem; border-radius: 0.375rem; border: none;
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
        }
        #cancel-print { background-color: #e9ecef; color: var(--font-color); }
        #confirm-print { background-color: var(--primary-color); color: white; }
        #get-omr-btn { background-color: var(--success-color); color: white; }
        #get-official-key-btn { background-color: #6f42c1; color: white; }

        .print-only-container { display: none; }

        @media (max-width: 768px) {
            .selector-container { max-width: 100%; } /* <-- MODIFIED: Allow full width on mobile */
            .selector-container h2 { font-size: 1.8rem; }
            .shift-selector { grid-template-columns: 1fr; gap: 1rem; }
            
            .header { padding: 0.5rem; gap: 0.5rem; justify-content: center; }
            .header h1 { order: 1; width: 100%; font-size: 1.1rem; padding: 0.25rem 0; text-align: center; }
            #toggle-info-bar-btn { position: absolute; left: 5px; top: 10px; margin: 0; }
            #reset-answers-btn { margin: 0; }
            .header-controls {
                order: 2; width: 100%; justify-content: space-around;
                gap: 0.5rem; padding: 0 0.5rem;
            }
            .header-controls label { display: none; }
            .header-controls select, .header-controls button {
                padding: 0.4rem 0.5rem; font-size: 0.75rem; flex-grow: 1; text-align: center;
            }
            #header-print-btn .print-text { display: none; }

            .container { margin: 1.5rem auto; padding: 0 0.75rem; }
            .controls-bar { margin-bottom: 1.5rem; padding: 0.5rem; }
            .filter-buttons { gap: 0.25rem; justify-content: space-between; }
            .filter-buttons button { padding: 0.4rem 0.6rem; font-size: 0.7rem; flex-grow: 1; }
            
            .summary-bar { padding: 0.75rem; gap: 0.5rem; grid-template-columns: repeat(4, 1fr); }
            #right-que-item, #raw-marks-item { grid-column: span 2; }
            .summary-item .count { font-size: 1.2rem; }
            .summary-item .label { font-size: 0.6rem; }
            
            .question-info-bar { padding: 0.5rem 1rem; }
            .question-content { padding: 1rem; }
            .question-content h3 { font-size: 1rem; }
            .options-container { padding: 1rem; }
            .options-grid { grid-template-columns: 1fr; }
            .options-grid li:last-child:nth-child(5) { grid-column: auto; }
            
            .modal-buttons { justify-content: center; gap: 0.25rem; }
            .modal-buttons button { padding: 0.5rem; font-size: 0.7rem; flex-grow: 1; }
        }

        @media print {
            body { font-size: 10pt; background-color: #fff !important; color: #000 !important; }
            .question-block, .print-header-details, .official-key-print-container { page-break-inside: avoid; }
            * { background-color: transparent !important; box-shadow: none !important; color: #000 !important; }
            
            .print-header-details { padding: 1cm 1cm 0; }
            .print-header-details h2 { text-align: center; margin-top: 0; margin-bottom: 1rem; font-size: 1.5rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
            .print-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1.5rem; margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ccc !important; border-radius: 8px; }
            .print-info-grid p { margin: 2px 0; font-size: 1rem; }
            .print-paper-code strong, .print-paper-code span { color: red !important; font-weight: bold !important; }
            .print-summary-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 1.5rem; }
            .print-summary-table th, .print-summary-table td { border: 1px solid #999 !important; padding: 5px; font-size: 0.9rem; }
            .print-summary-table th { background-color: #f2f2f2 !important; font-weight: bold; }
            #print-correct-cell { color: var(--success-color) !important; font-weight: bold; }
            #print-incorrect-cell { color: var(--danger-color) !important; font-weight: bold; }
            
            .question-block { margin-bottom: 0.5rem !important; border: none !important; border-bottom: 1px dashed #aaa !important; }
            .question-block:last-of-type { border-bottom: none !important; }
            .question-info-bar { display: none !important; }
            #question-paper-page.hide-q-info .question-info-bar { display: none !important; }
            .question-content, .options-container { padding: 0.4rem 8px !important; }
            .question-content h3 { font-size: 10.5pt; margin: 0 0 0.4rem 0 !important; font-weight: normal; }
            .question-content h3 .print-q-num { font-weight: bold; }
            .options-list { margin-top: 0.3rem !important; gap: 3px !important; }
            .options-list li { padding: 4px 8px !important; font-size: 10pt !important; border: 1px solid #ccc !important; }
            .correct-answer-display { font-size: 9pt; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #ddd !important; }
            .options-list li.correct, .options-list li.incorrect, .options-list li.special, .options-list li.selected-neutral {
                -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
            }
            .options-list li.correct { background-color: var(--success-bg) !important; }
            .options-list li.incorrect { background-color: var(--danger-bg) !important; }
            .options-list li.special { background-color: var(--special-bg) !important; }
            .options-list li.selected-neutral { background-color: #e9ecef !important; }
            
            body.omr-print-body .print-header-details { padding: 0.5cm 1cm 0 !important; }
            body.omr-print-body .print-header-details h2 { font-size: 1.1rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; }
            body.omr-print-body .print-info-grid { gap: 0 0.5rem; margin-bottom: 0.4rem; padding: 0.4rem; }
            body.omr-print-body .print-info-grid p { font-size: 0.75rem; }
            body.omr-print-body .print-summary-table { margin-bottom: 0.5rem; }
            body.omr-print-body .print-summary-table th, body.omr-print-body .print-summary-table td { padding: 2px; font-size: 0.7rem; }
            .omr-grid { display: flex; justify-content: space-between; gap: 10px; padding: 0 1cm 1cm; }
            .omr-column { width: 24%; border: 1px solid #ccc !important; border-radius: 5px; padding: 10px 5px 5px 10px; }
            .omr-row { display: flex; align-items: center; margin-bottom: 5.8px; }
            .omr-q-num { font-weight: bold; width: 35px; }
            .omr-options { display: flex; }
            .omr-bubble { width: 18px; height: 18px; border: 1px solid #000 !important; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; margin-right: 5px; }
            .omr-bubble.filled { background-color: #0d47a1 !important; border-color: #0d47a1 !important; color: white !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            .omr-bubble.filled-neutral { background-color: #555 !important; border-color: #333 !important; color: white !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }

            .official-key-print-container { padding: 1cm; }
            .official-key-header h1 { text-align: center; font-size: 1.5rem; margin: 0 0 0.5rem 0; }
            .official-key-header p { text-align: center; font-size: 1.1rem; margin: 0 0 1.5rem 0; font-weight: bold; }
            .official-key-grid { display: flex; justify-content: space-around; align-items: flex-start; gap: 1.5rem; }
            .official-key-column { width: 45%; }
            .official-key-table { width: 100%; border-collapse: collapse; }
            .official-key-table th, .official-key-table td { border: 1px solid #333 !important; padding: 5px; text-align: center; font-size: 10pt; }
            .official-key-table th { background-color: #f2f2f2 !important; }
            .official-key-footer {
                margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #ccc !important;
                text-align: center; font-size: 9pt; color: #555 !important;
            }
        }
        
        /* ======================= START: THEME SELECTOR CSS ======================= */
        .theme-selector {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 100;
        }
        #theme-toggle-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--font-color);
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        #theme-toggle-btn:hover {
            box-shadow: var(--shadow-md);
            color: var(--primary-color);
        }
        #theme-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            list-style: none;
            padding: 0.5rem;
            margin: 0;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 200px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #theme-dropdown.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        #theme-dropdown li {
            padding: 0.6rem 1rem;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, color 0.2s;
            color: var(--font-color);
        }
        #theme-dropdown li:hover {
            background-color: var(--subtle-bg);
            color: var(--primary-color);
        }

        /* --- Theme Palettes Start --- */
        :root[data-theme='dark-blue'] {
            --primary-color: #3b82f6; --primary-dark: #2563eb; --primary-light: #1e3a8a;
            --bg-color: #111827; --surface-color: #1f2937; --font-color: #f3f4f6;
            --font-color-light: #9ca3af; --border-color: #374151; --success-bg: #064e3b;
            --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #374151;
        }
        :root[data-theme='light-green'] {
            --primary-color: #22c55e; --primary-dark: #16a34a; --primary-light: #dcfce7;
        }
        :root[data-theme='dark-green'] {
            --primary-color: #4ade80; --primary-dark: #22c55e; --primary-light: #14532d;
            --bg-color: #18181b; --surface-color: #27272a; --font-color: #f4f4f5;
            --font-color-light: #a1a1aa; --border-color: #3f3f46; --success-bg: #064e3b;
            --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #3f3f46;
        }
        :root[data-theme='light-purple'] {
            --primary-color: #8b5cf6; --primary-dark: #7c3aed; --primary-light: #ede9fe;
        }
        :root[data-theme='dark-purple'] {
            --primary-color: #a78bfa; --primary-dark: #8b5cf6; --primary-light: #3b0764;
            --bg-color: #171321; --surface-color: #251e39; --font-color: #f1f0f5;
            --font-color-light: #a9a2c1; --border-color: #403561; --success-bg: #064e3b;
            --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #403561;
        }
        :root[data-theme='light-orange'] {
            --primary-color: #f97316; --primary-dark: #ea580c; --primary-light: #ffedd5;
        }
        :root[data-theme='dark-orange'] {
            --primary-color: #fb923c; --primary-dark: #f97316; --primary-light: #7c2d12;
            --bg-color: #201a18; --surface-color: #302824; --font-color: #f5f0ee;
            --font-color-light: #b0a8a4; --border-color: #514641; --success-bg: #064e3b;
            --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #514641;
        }
        :root[data-theme='light-teal'] {
            --primary-color: #14b8a6; --primary-dark: #0d9488; --primary-light: #ccfbf1;
        }
        :root[data-theme='dark-teal'] {
            --primary-color: #2dd4bf; --primary-dark: #14b8a6; --primary-light: #042f2e;
            --bg-color: #0f172a; --surface-color: #1e2b; --font-color: #f1f5f9;
            --font-color-light: #94a3b8; --border-color: #334155; --success-bg: #064e3b;
            --danger-bg: #7f1d1d; --special-bg: #78350f; --subtle-bg: #334155;
        }
        :root[data-theme='solarized-light'] {
            --primary-color: #268bd2; --primary-dark: #002b36; --primary-light: #eee8d5;
            --bg-color: #fdf6e3; --surface-color: #eee8d5; --font-color: #657b83;
            --font-color-light: #93a1a1; --border-color: #93a1a1; --success-bg: #dff0d8;
            --danger-bg: #f2dede; --special-bg: #fcf8e3; --subtle-bg: #eee8d5;
        }
        :root[data-theme='solarized-dark'] {
            --primary-color: #268bd2; --primary-dark: #93a1a1; --primary-light: #073642;
            --bg-color: #002b36; --surface-color: #073642; --font-color: #839496;
            --font-color-light: #586e75; --border-color: #586e75; --success-bg: #2d4f2d;
            --danger-bg: #6b3e3e; --special-bg: #635741; --subtle-bg: #0b4250;
        }
        /* ======================== END: THEME SELECTOR CSS ========================= */

        /* ======================== START: NEW WARNING BOX CSS (ADDED) ========================= */
        #unattempted-warning-item {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            text-align: center;
            color: var(--danger-color);
            background-color: var(--danger-bg);
            border: 1px solid var(--danger-color);
            font-size: 0.9rem;
            font-weight: 500;
            display: none; /* Hide by default */
        }
        #unattempted-warning-item.visible {
            display: block; /* Show with JS */
        }
        /* ======================== END: NEW WARNING BOX CSS (ADDED) ========================= */
        /* ======================== START: LEADERBOARD MOBILE STYLES ========================= */
@media (max-width: 768px) {
    /* Step 1: स्क्रीन को फुल-विड्थ बनाने के लिए बाहरी पैडिंग कम करें */
    #shift-selector-page, .selector-container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    #leaderboard-section {
        margin-top: 2rem;
    }
    
    /* Step 2: टेबल के टेक्स्ट को छोटा और कॉम्पैक्ट करें */
    #leaderboard-table th,
    #leaderboard-table td {
        padding: 0.5rem 0.25rem; /* ऊपर-नीचे और अगल-बगल की पैडिंग कम करें */
        font-size: 0.7rem;      /* फ़ॉन्ट का साइज़ छोटा करें */
        text-align: center;       /* टेक्स्ट को बीच में लाएं */
        white-space: nowrap;      /* टेक्स्ट को एक लाइन में रखने की कोशिश करें */
    }

    /* नाम वाले कॉलम को लेफ्ट-अलाइंड रखें ताकि वह सही दिखे */
    #leaderboard-table th:nth-child(2),
    #leaderboard-table td:nth-child(2) {
        text-align: left;
        white-space: normal; /* नाम लंबा होने पर उसे अगली लाइन में भेजें */
    }

    /* Step 3: फिल्टर कंट्रोल को बेहतर बनाएं */
    .leaderboard-controls {
        flex-direction: column; /* कंट्रोल्स को एक के नीचे एक लाएं */
        align-items: stretch;   /* कंट्रोल्स को पूरी चौड़ाई दें */
        gap: 0.5rem;
    }
}
/* ======================== END: LEADERBOARD MOBILE STYLES ========================= */
        /* ======================== START: SHIFT BUTTON BORDER ANIMATION ========================= */
.shift-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 150%; /* बॉक्स से बड़ा ताकि घूम सके */
    height: 300%; /* बॉक्स से बड़ा ताकि घूम सके */
    z-index: -1; /* बटन के टेक्स्ट के पीछे रखने के लिए */
    background: conic-gradient(
        var(--primary-color) 20deg, 
        transparent 120deg
    );
    animation: rotate-border 4s linear infinite;
}

@keyframes rotate-border {
    0% {
        transform: translate(-50%, -50%) rotate(0deg);
    }
    100% {
        transform: translate(-50%, -50%) rotate(360deg);
    }
}
/* ======================== END: SHIFT BUTTON BORDER ANIMATION ========================= */
        /* ======================= START: NEW VIEW MODE CSS ======================= */

    /* 1. Wrapper for the new dropdown */
    .view-mode-selector {
        position: absolute;
        left: 5px;
        top: 10px;
        z-index: 10;
    }

    /* 2. The new "Eye" button */
    #view-mode-btn {
        background: none;
        border: none;
        font-size: 0.9rem; /* थोड़ा छोटा टेक्स्ट */
        cursor: pointer;
        color: var(--secondary-color);
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    #view-mode-btn:hover {
        background-color: var(--subtle-bg);
    }
    #view-mode-btn i {
        margin-right: 0.4rem;
    }

    /* 3. The dropdown menu */
    #view-mode-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        padding: 0.5rem;
        margin: 0.25rem 0 0 0;
        list-style: none;
        width: 200px;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    #view-mode-dropdown.hidden {
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
    }
    #view-mode-dropdown li {
        padding: 0.6rem 1rem;
        cursor: pointer;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
        color: var(--font-color);
    }
    #view-mode-dropdown li:hover {
        background-color: var(--subtle-bg);
    }
    #view-mode-dropdown li i {
        margin-right: 0.75rem;
        width: 1.2em;
        text-align: center;
    }

    /* 4. CSS rules for the 3 view modes */

    /* "With Option" (Default) - Hide info bar */
    #question-paper-page[data-view-mode="with-option"] .question-info-bar {
        display: none;
    }

    /* "All Series" - Show info bar (default behavior, no rule needed) */

    /* "Only Option" - Hide info bar, question text, and image */
/* ================= START: ONLY OPTION MODE (OMR LAYOUT) ================= */

    /* "Only Option" - OMR की तरह हॉरिजॉन्टल लेआउट */
    #question-paper-page[data-view-mode="only-option"] .question-info-bar {
        display: none;
    }
    #question-paper-page[data-view-mode="only-option"] .question-text,
    #question-paper-page[data-view-mode="only-option"] .question-content img {
        display: none; /* प्रश्न टेक्स्ट और इमेज को छिपाएं */
    }

    /* पूरे प्रश्न ब्लॉक को एक हॉरिजॉन्टल लाइन बनाएं */
    #question-paper-page[data-view-mode="only-option"] .question-block {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        padding: 0.5rem 1rem; /* ब्लॉक के अंदर थोड़ी पैडिंग */
        border-bottom: 1px dashed var(--border-color); /* प्रश्नों के बीच हल्की लाइन */
    }

    /* प्रश्न संख्या (h3) वाले हिस्से को स्टाइल करें */
    #question-paper-page[data-view-mode="only-option"] .question-content {
        padding: 0;
        margin: 0 1rem 0 0; /* संख्या और गोलों के बीच गैप */
        flex-shrink: 0; /* इसे सिकुड़ने न दें */
    }
    #question-paper-page[data-view-mode="only-option"] .question-content h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
    }

    /* ऑप्शन (ul) वाले कंटेनर को स्टाइल करें */
    #question-paper-page[data-view-mode="only-option"] .options-container {
        padding: 0;
        background-color: transparent;
        flex-grow: 1; /* बची हुई जगह ले लें */
    }

    /* ऑप्शन की लिस्ट (ul) को एक सीधी हॉरिजॉन्टल लाइन बनाएं */
    #question-paper-page[data-view-mode="only-option"] .options-list {
        flex-direction: row;
        justify-content: flex-start;
        gap: 0.5rem;
        flex-wrap: nowrap;  /* यह गोलों को अगली लाइन में जाने से रोकेगा */
        overflow-x: auto;   /* ज़रूरत पड़ने पर हॉरिजॉन्टल स्क्रॉल देगा */
        padding: 0.2rem 0;  /* हल्का सा ऊपर-नीचे पैडिंग */
    }

    /* ऑप्शन के गोलों (li) को स्टाइल करें */
    #question-paper-page[data-view-mode="only-option"] .options-list li {
        padding: 0;
        width: 40px; 
        height: 40px; 
        flex-shrink: 0; /* यह गोलों को सिकुड़ने से रोकेगा */
        display: grid;
        place-items: center;
        border-radius: 50%;
        font-weight: 700;
    }

    /* ऑप्शन के टेक्स्ट (A, B) के अलावा बाकी टेक्स्ट छिपा दें */
    #question-paper-page[data-view-mode="only-option"] .options-list .option-text {
        display: none;
    }

    /* ग्रिड लेआउट को डिसेबल करें */
   /* ग्रिड लेआउट को डिसेबल करें (display: grid को override करें) */
    #question-paper-page[data-view-mode="only-option"] .options-list.options-grid {
         display: flex; /* 'display: grid' को 'display: flex' से बदलें */
         grid-template-columns: none; /* ग्रिड सेटिंग को रीसेट करें */
    }
    /* सही उत्तर को छिपा दें */
    #question-paper-page[data-view-mode="only-option"] .correct-answer-display {
        display: none;
    }
    /* ================= END: ONLY OPTION MODE (OMR LAYOUT) ================= */
    /* Adjust header title on mobile to prevent overlap */
    @media (max-width: 768px) {
        #view-mode-selector {
            top: 8px; /* Adjust position */
        }
        #view-mode-btn {
            font-size: 0.8rem;
            padding: 0.2rem 0.3rem;
        }
        #view-mode-btn #view-mode-label {
            display: none; /* Hide text label on mobile */
        }
        #view-mode-btn i {
            margin-right: 0;
        }
        .header h1 {
            padding-left: 30px; /* Add padding to avoid overlap */
            padding-right: 30px;
        }
    }
        #question-paper-page[data-view-mode="only-option"] .correct-answer-display {
        display: none;
    }
    /* ======================== END: NEW VIEW MODE CSS ======================= */
        /* ======================= START: CARD VIEW MODE CSS ======================= */
        
        /* 1. जब कार्ड मोड सक्रिय न हो, तो नेविगेशन को छिपा दें */
        #question-paper-page:not([data-view-mode="card-mode"]) #card-navigation {
            display: none !important;
        }

      /* 2. जब कार्ड मोड सक्रिय हो, तो नेविगेशन दिखाएं */
#question-paper-page[data-view-mode="card-mode"] #card-navigation {
    /* लेआउट और पोजीशन */
    display: flex;
    position: fixed;  /* ⚡️ यह इसे स्क्रीन पर चिपका देगा */
    bottom: 0;        /* ⚡️ यह इसे नीचे रखेगा */
    left: 0;
    width: 100%;
    z-index: 1001;    /* यह इसे कंटेंट के ऊपर रखेगा */

    /* स्टाइल (जो हमने HTML से हटाई थी) */
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: var(--surface-color);
    border-top: 1px solid var(--border-color); /* ऊपर बॉर्डर */
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* हल्की छाया */
}
        #card-navigation button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        /* 3. कार्ड मोड में कंटेनर को फुल-विड्थ करें */
        #question-paper-page[data-view-mode="card-mode"] .container {
            max-width: 100%;
            padding: 0;
            margin-top: 1rem;
        }

        /* 4. कार्ड मोड में फ़िल्टर बार को छिपा दें */
        #question-paper-page[data-view-mode="card-mode"] .controls-bar {
            display: none;
        }

        /* 5. हॉरिजॉन्टल स्लाइडर बनाएं */
        #question-paper-page[data-view-mode="card-mode"] #questions-container {
            display: flex;
            overflow-x: scroll;
            scroll-snap-type: x mandatory; /* यह इसे कार्ड की तरह स्नैप (चिपकने) में मदद करता है */
            -webkit-overflow-scrolling: touch; /* iOS पर स्मूथ स्क्रॉलिंग */
            scroll-behavior: smooth;
            padding-bottom: 6rem; /* ⚡️ नीचे अतिरिक्त जगह (लगभग 80px) */
            /* --- START: SCROLLBAR HIDE --- */
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            cursor: grab; /* माउस ड्रैग के लिए कर्सर */
        }
        #question-paper-page[data-view-mode="card-mode"] #questions-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        /* --- END: SCROLLBAR HIDE --- */

        /* 6. प्रत्येक प्रश्न को एक फुल-स्क्रीन कार्ड बनाएं */
        #question-paper-page[data-view-mode="card-mode"] .question-block {
            flex: 0 0 100vw; /* प्रत्येक कार्ड की चौड़ाई 100% (viewport width) होगी */
            scroll-snap-align: center; /* कार्ड को बीच में स्नैप करें */
            border: none;
            border-radius: 0;
            margin-bottom: 0;
            box-shadow: none;
            overflow-y: auto; /* अगर प्रश्न लंबा है तो कार्ड के अंदर स्क्रॉलिंग हो */
            height: calc(100vh - 270px); /* स्क्रीन के हिसाब से ऊंचाई (हेडर और नेविगेशन को छोड़कर) */
        }
        
        /* 7. कार्ड के अंदर पैडिंग दें */
        #question-paper-page[data-view-mode="card-mode"] .question-content,
        #question-paper-page[data-view-mode="card-mode"] .options-container {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        /* 8. प्रश्न की जानकारी (सीरीज नंबर) को छिपा दें */
        #question-paper-page[data-view-mode="card-mode"] .question-info-bar {
            display: none;
        }

        /* 9. मोबाइल के लिए एडजस्टमेंट */
        @media (max-width: 768px) {
            #question-paper-page[data-view-mode="card-mode"] .question-block {
                height: calc(100vh - 220px); /* मोबाइल हेडर के हिसाब से ऊंचाई */
            }
         #card-navigation {
    padding: 0.5rem;
    margin: 0; /* ⚡️ फिक्स्ड पोजीशन के लिए मार्जिन हटाया */
}
            #card-navigation button {
                padding: 0.5rem 0.8rem;
                font-size: 0.9rem;
            }
            #card-counter {
                font-size: 1rem;
            }
        }
        /* ======================== END: CARD VIEW MODE CSS ======================= */
        /* ======================= START: JUMP TO QUESTION CSS ======================= */
        #jump-to-q-btn {
            position: absolute;
            left: 55px; /* View mode बटन के बगल में */
            top: 10px;
            z-index: 10;
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--secondary-color);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #jump-to-q-btn:hover {
            background-color: var(--subtle-bg);
        }

        #jump-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 1;
            transition: opacity 0.2s ease;
        }
        #jump-modal-overlay.jump-modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        #jump-modal {
            background-color: var(--surface-color);
            color: var(--font-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 600px; /* पॉपअप की अधिकतम चौड़ाई */
            padding: 1.5rem;
            max-height: 80vh; /* ऊंचाई सीमित करें */
            display: flex;
            flex-direction: column;
        }
        #jump-modal h3 {
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: 1.2rem;
        }
        #jump-grid-container {
            display: grid;
            /* ग्रिड को ऑटो-फिट करें */
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            overflow-y: auto; /* ज़्यादा प्रश्न होने पर स्क्रॉल करें */
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            flex-grow: 1;
        }
        .jump-q-btn {
            width: 40px; height: 40px;
            border-radius: 50%; /* गोल बटन */
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--font-color);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }
        .jump-q-btn:hover {
            background-color: var(--subtle-bg);
            border-color: var(--primary-color);
        }
        /* उत्तर की स्थिति के अनुसार रंग */
        .jump-q-btn[data-status="correct"] { background-color: var(--success-bg); border-color: var(--success-color); }
        .jump-q-btn[data-status="incorrect"] { background-color: var(--danger-bg); border-color: var(--danger-color); }
        .jump-q-btn[data-status="skipped"] { background-color: var(--special-bg); border-color: var(--warning-color); }
        .jump-q-btn[data-status="deleted"] { background-color: #e9ecef; color: #aaa; text-decoration: line-through; }

        #close-jump-modal-btn {
            margin-top: 1.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 600;
            align-self: flex-end; /* बटन को दाएं कोने में रखें */
        }

        /* मोबाइल के लिए एडजस्टमेंट */
        @media (max-width: 768px) {
            #jump-to-q-btn {
                left: 40px; /* मोबाइल पर थोड़ी जगह बदलें */
                top: 8px;
            }
            .header h1 {
                /* हेडर टाइटल को बटन से टकराने से रोकें */
                padding-left: 60px; 
                padding-right: 60px;
            }
        }
        /* ======================== END: JUMP TO QUESTION CSS ======================= */
        /* ================== START: HEADER REDESIGN CSS ================== */
        
        /* 1. मुख्य हेडर को वर्टिकल स्टैक बनाएं */
        .header {
            flex-direction: column;
            padding: 0.25rem 0.5rem; /* पैडिंग बहुत कम कर दी */
            gap: 0.25rem; /* पंक्तियों के बीच गैप कम कर दिया */
        }

        /* 2. पंक्ति 1: आइकन बार */
        .header-icon-bar {
            display: flex;
            justify-content: space-between; /* बाएं और दाएं ग्रुप को अलग करें */
            align-items: center;
            width: 100%;
        }
        .header-icon-bar-left {
            display: flex;
            align-items: center;
        }

        /* 3. पंक्ति 2: टाइटल */
        #shift-title {
            order: 2; /* इसे बीच में रखें */
            width: 100%;
            text-align: center;
            font-size: 1.0rem; /* छोटा फ़ॉन्ट */
            font-weight: 600;
            margin: 0; /* फालतू मार्जिन हटाया */
            padding: 0; /* फालतू पैडिंग हटाई */
        }

        /* 4. पंक्ति 3: कंट्रोल्स */
        .header-controls {
            order: 3; /* इसे आखिर में रखें */
            width: 100%;
            justify-content: space-between;
            gap: 0.5rem;
        }
        
        /* 5. सभी आइकन्स और बटन्स को छोटा करें */

        /* पंक्ति 1 के आइकन */
        #view-mode-btn, #jump-to-q-btn, #reset-answers-btn {
            font-size: 0.8rem; /* छोटा फ़ॉन्ट */
            padding: 0.2rem 0.4rem; /* छोटी पैडिंग */
            margin: 0; /* फालतू मार्जिन हटाया */
        }
        /* आइकन का साइज़ */
        #view-mode-btn i, #jump-to-q-btn i, #reset-answers-btn i {
             font-size: 1.0rem;
        }
        /* व्यू मोड बटन से टेक्स्ट "With Option" छिपा दें */
        #view-mode-label {
            display: none;
        }
         #view-mode-btn i {
            margin-right: 0; /* टेक्स्ट हटने के बाद मार्जिन हटाया */
         }

        /* पंक्ति 3 के बटन और सेलेक्ट */
        .header-controls select, .header-controls button {
            padding: 0.3rem 0.5rem; /* छोटी पैडिंग */
            font-size: 0.75rem; /* छोटा फ़ॉन्ट */
            flex-grow: 1;
            flex-basis: 0;
        }
        
        /* 6. मोबाइल के लिए अतिरिक्त सुधार */
        @media (max-width: 768px) {
            #shift-title {
                font-size: 0.9rem; /* मोबाइल पर और छोटा टाइटल */
            }
            .header-controls select, .header-controls button {
                font-size: 0.7rem; /* मोबाइल पर और छोटा फ़ॉन्ट */
            }
        }
        /* ================== END: HEADER REDESIGN CSS ================== */
        /* सुझाव 1 के लिए एनीमेशन */
        @keyframes text-gradient-flow {
            0% { background-position: 200% center; }
            100% { background-position: 0% center; }
        }
    </style>
    
</head>
<body>

    <div class="theme-selector">
        <button id="theme-toggle-btn" title="Change Theme">
            <i class="fas fa-palette"></i>
        </button>
        <ul id="theme-dropdown" class="hidden">
            <li data-theme="auto">Auto (System Default)</li>
            <li data-theme="light-blue">Default Light</li>
            <li data-theme="dark-blue">Default Dark</li>
            <li data-theme="light-green">Green Light</li>
            <li data-theme="dark-green">Green Dark</li>
            <li data-theme="light-purple">Purple Light</li>
            <li data-theme="dark-purple">Purple Dark</li>
            <li data-theme="light-orange">Orange Light</li>
            <li data-theme="dark-orange">Dark Dark</li>
            <li data-theme="light-teal">Teal Light</li>
            <li data-theme="dark-teal">Dark Teal</li>
            <li data-theme="solarized-light">Solarized Light</li>
            <li data-theme="solarized-dark">Solarized Dark</li>
        </ul>
    </div>
    <div class="print-only-container">
        <div id="print-fallback-details" class="print-header-details">
            <h2 id="print-title"></h2>
            <div class="print-info-grid">
                <p><strong>नाम:</strong> <span id="print-name"></span></p>
                <p class="print-paper-code"><strong>पेपर कोड:</strong> <span id="print-series"></span></p>
                <p><strong>रोल नंबर:</strong> <span id="print-roll"></span></p>
                <p><strong>RAW Marks:</strong> <span id="print-raw-marks-display"></span></p>
            </div>
            <table class="print-summary-table">
                <thead>
                    <tr>
                        <th>कुल प्रश्न</th> <th>वैध प्रश्न</th> <th>हल किए</th> <th>सही</th> <th>गलत</th> <th>छोड़े (E)</th> <th>Delete</th> <th>अंतिम सही प्रश्न</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span id="print-full-total"></span></td>
                        <td><span id="print-valid-total"></span></td>
                        <td><span id="print-attempted"></span></td>
                        <td id="print-correct-cell"></td>
                        <td id="print-incorrect-cell"></td>
                        <td><span id="print-skipped"></span></td>
                        <td><span id="print-deleted"></span></td>
                        <td id="print-final-rq-display"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="omr-print-container"></div>
        <div id="official-key-print-container"></div>
    </div>

    <div id="shift-selector-page">
        <div class="selector-container">
            <h2>चतुर्थ श्रेणी कर्मचारी</h2>
               <p style="text-align:center; color: red;"> Official Answer Key Updated</p>
            <p class="subtitle">कृपया अपनी शिफ़्ट चुनें।</p>
            <div class="shift-selector">
                <a class="shift-btn" data-shift="shift1"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">1st Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift2"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">2nd Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift3"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">3rd Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift4"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">4th Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift5"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">5th Shift 21.09.2025</div></a>
                <a class="shift-btn" data-shift="shift6"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">6th Shift 21.09.2025</div></a>
            </div>
            <div class="selector-footer">
              
             
                <p>
                    <a href="https://t.me/Dreamlinkmp" target="_blank" class="creator-link" style="color: blue; text-decoration: underline;">Join Telegram Group</a>
                </p>
            </div>
            <div id="leaderboard-section" style="margin-top: 3rem; width: 100%; text-align: left;">
                
                <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin-top: 0; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">लीडरबोर्ड</h4>

                <div class="leaderboard-controls" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label for="leaderboard-shift-filter">शिफ़्ट के अनुसार फ़िल्टर करें:</label>
                    <select id="leaderboard-shift-filter" style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color);">
                        <option value="all">सभी शिफ़्ट</option>
                        <option value="shift1">1st Shift</option>
                        <option value="shift2">2nd Shift</option>
                        <option value="shift3">3rd Shift</option>
                        <option value="shift4">4th Shift</option>
                        <option value="shift5">5th Shift</option>
                        <option value="shift6">6th Shift</option>
                    </select>
                    <button id="view-leaderboard-btn" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; background-color: var(--primary-color); color: white; cursor: pointer;">लीडरबोर्ड देखें</button>
                </div>

                <div id="leaderboard-table-container" style="overflow-x: auto; display: none; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                    <table id="leaderboard-table" style="width: 100%; border-collapse: collapse; text-align: left;">
    <thead>
        <tr>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">रैंक</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">नाम</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">जेंडर</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">एरिया</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">कैटेगरी</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">विशेष</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">रॉ मार्क्स</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">सही</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">गलत</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">छोड़े गए</th>
            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">शिफ़्ट</th>
        </tr>
    </thead>
    <tbody id="leaderboard-body">
    </tbody>
</table>
                    <p id="leaderboard-loading" style="text-align: center; padding: 1rem; display: none;">Loading...</p>
                </div>
            </div> 
         </div>
    </div>

    <div id="question-paper-page">
        <div class="top-sticky-bar">
            <div class="header">
                
                <div class="header-icon-bar">
                    <div class="header-icon-bar-left">
                        <div id="view-mode-selector" class="view-mode-selector">
                            <button id="view-mode-btn" title="Change View Mode">
                                <i class="fas fa-list-ul"></i> <span id="view-mode-label">With Option</span>
                            </button>
                            <ul id="view-mode-dropdown" class="hidden">
                                <li data-view="with-option"><i class="fas fa-list-ul"></i> With Option</li>
                                <li data-view="all-series"><i class="fas fa-sitemap"></i> With All Series Q.N.</li>
                                <li data-view="only-option"><i class="fas fa-dot-circle"></i> Only Option</li>
                                <li data-view="card-mode"><i class="fas fa-clone"></i> Card Mode</li>
                            </ul>
                        </div>
                        <button id="jump-to-q-btn" title="Jump to Question"><i class="fas fa-th-large"></i></button>
                    </div>
                    <button id="reset-answers-btn" title="Reset Answers"><i class="fas fa-sync-alt"></i></button>
                </div>

                <h1 id="shift-title">Shift Title</h1> 
                
                <div class="header-controls">
                    <label for="series-select">Paper Code:</label>
                    <select id="series-select"></select>
                    <button id="toggle-summary-btn">Show Result</button>
                    <button id="header-print-btn"><i class="fas fa-print"></i><span class="print-text"> Print</span></button>
                </div>

            </div>
            <div class="summary-bar hidden">
                <div id="total-item" class="summary-item"><div id="total-count" class="count">0</div><div class="label">Valid Que.</div></div>
                <div id="attempted-item" class="summary-item"><div id="attempted-count" class="count">0</div><div class="label">Attempt</div></div>
                <div id="correct-item" class="summary-item"><div id="correct-count" class="count">0</div><div class="label">Right</div></div>
                <div id="incorrect-item" class="summary-item"><div id="incorrect-count" class="count">0</div><div class="label">Wrong</div></div>
                <div id="skipped-item" class="summary-item"><div id="skipped-count" class="count">0</div><div class="label">Skip (E)</div></div>
                <div id="deleted-item" class="summary-item"><div id="deleted-count" class="count">0</div><div class="label">Deleted</div></div>
                <div id="right-que-item" class="summary-item"><div id="right-que-value" class="count">0.00</div><div class="label">Final R.Q.</div></div>
                <div id="raw-marks-item" class="summary-item"><div id="raw-marks-value" class="count">0.00</div><div class="label">RAW Marks</div></div>
                <div id="unattempted-warning-item" class="summary-item">
                    <span>अभी तक <strong id="unattempted-count">0</strong> प्रश्नों में कोई भी ऑप्शन टिक नहीं है।</span>
                </div>
                </div>
        </div>
        <div class="container">
            <div class="controls-bar">
                <div class="filter-buttons">
                    <button class="active" data-filter="all">All</button>
                    <button data-filter="correct">Right</button>
                    <button data-filter="incorrect">Wrong</button>
                    <button data-filter="skipped">Skip (E)</button>
                    <button data-filter="deleted">Deleted</button>
                </div>
            </div>
            <div id="questions-container"></div>
       <div id="card-navigation" style="display: none;">
                <button id="prev-question-btn" style="background-color: var(--primary-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;"><i class="fas fa-arrow-left"></i> Previous</button>
                <span id="card-counter" style="font-size: 1.1rem; font-weight: 600; color: var(--font-color);">1 / 100</span>
                <button id="next-question-btn" style="background-color: var(--primary-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;">Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        
    </div>

    <div id="print-modal-overlay">
        <div id="print-modal">
            <h2>Print Details</h2>
            <label for="student-name">Name:</label>
            <input type="text" id="student-name" placeholder="Your Name">
            <label for="student-roll">Roll No.:</label>
            <input type="text" id="student-roll" placeholder="Your Roll No.">
            <div class="modal-buttons">
                <button id="cancel-print">Cancel</button>
                <button id="get-official-key-btn">Answer Key</button>
                <button id="get-omr-btn">Print OMR</button>
                <button id="confirm-print">Paper Print</button>
            </div>
        </div>
    </div>
    
    <div id="user-info-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2001; align-items: center; justify-content: center; padding: 1rem;">
        <div id="user-info-modal" style="background: var(--surface-color); color: var(--font-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-top: 0;">Welcome!</h2>
    <p style="margin: 0 0 1.5rem 0; color: var(--font-color-light);">Roll No. के अलावा सभी जानकारी लीडरबोर्ड मे दिखाई देगी </p>
    
    <label for="initial-student-name" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Name:</label>
    <input type="text" id="initial-student-name" placeholder="Your Name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; margin-bottom: 1rem; background-color: var(--bg-color); color: var(--font-color);">
    
    <label for="initial-student-roll" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Roll No.:</label>
    <input type="text" id="initial-student-roll" placeholder="Your Roll No." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; margin-bottom: 1rem; background-color: var(--bg-color); color: var(--font-color);">
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
            <label for="initial-student-gender" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Gender:</label>
            <select id="initial-student-gender" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; background-color: var(--bg-color); color: var(--font-color);">
                <option value="">-- Select --</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div>
            <label for="initial-student-area" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Area:</label>
            <select id="initial-student-area" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; background-color: var(--bg-color); color: var(--font-color);">
                <option value="">-- Select --</option>
                <option value="NTSP">Non-TSP</option>
                <option value="TSP">TSP</option>
            </select>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
            <label for="initial-student-category" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Category:</label>
            <select id="initial-student-category" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; background-color: var(--bg-color); color: var(--font-color);">
                <option value="">-- Select --</option>
                <option value="GEN">GEN</option>
                <option value="EWS">EWS</option>
                <option value="OBC">OBC</option>
                <option value="MBC">MBC</option>
                <option value="SC">SC</option>
                <option value="ST">ST</option>
                <option value="SAH">SAH</option>
            </select>
        </div>
        <div>
            <label for="initial-student-special" style="margin: 0 0 0.5rem 0; display: block; font-weight: 500;">Special Category:</label>
            <select id="initial-student-special" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 1rem; font-family: inherit; background-color: var(--bg-color); color: var(--font-color);">
                <option value="">-- None --</option>
                <option value="Widow">Widow</option>
                <option value="Divorcee">Divorcee</option>
                <option value="Ex-Serviceman">Ex-Serviceman</option>
                <option value="Sports Person">Sports Person</option>
            </select>
        </div>
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="start-test-btn" style="padding: 0.6rem 1.2rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; background-color: var(--primary-color); color: white;">चेक करना शुरू करे</button>
          </div>
       </div>
    </div>
    <div id="jump-modal-overlay" class="jump-modal-hidden">
        <div id="jump-modal">
            <h3 id="jump-modal-title">Jump to Question</h3>
            <div id="jump-grid-container">
                </div>
            <button id="close-jump-modal-btn">Close</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="questions-data.js"></script>
   <script>
    // START: FIREBASE CONFIG (ADDED)
    const firebaseConfig = {
  apiKey: "AIzaSyBfL_owhzOEZPvCCAeuT55axrIQxsf1gqQ",
  authDomain: "th-grade-official.firebaseapp.com",
  projectId: "th-grade-official",
  storageBucket: "th-grade-official.firebasestorage.app",
  messagingSenderId: "327380792213",
  appId: "1:327380792213:web:7c9f5f383993f885cfbc9c"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // END: FIREBASE CONFIG (ADDED)

    let currentShiftId = null, allQuestions = [], userAnswers = {}, currentSeries = '', activeFilter = 'all', currentShiftData = {};
       let currentCardIndex = 0, totalCards = 0;

    document.addEventListener('DOMContentLoaded', () => {
// --- START: CARD MODE MOUSE DRAG ---
        let isDown = false;
        let startX;
        let scrollLeft;
        const slider = document.getElementById('questions-container');

        if (slider) {
            slider.addEventListener('mousedown', (e) => {
                // यह सिर्फ कार्ड-मोड में काम करे
                if (questionPaperPage.dataset.viewMode !== 'card-mode') return;
                isDown = true;
                slider.style.cursor = 'grabbing';
                slider.style.scrollBehavior = 'auto'; // ड्रैग करते समय स्मूथ स्क्रॉल बंद करें
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
                if (questionPaperPage.dataset.viewMode !== 'card-mode') return;
                isDown = false;
                slider.style.cursor = 'grab';
                if (slider.style.scrollBehavior === 'auto') { // अगर ड्रैग हो रहा था
                   snapToCard(); // माउस छोड़ने पर कार्ड पर स्नैप करें
                }
            });

            slider.addEventListener('mouseup', () => {
                if (questionPaperPage.dataset.viewMode !== 'card-mode') return;
                isDown = false;
                slider.style.cursor = 'grab';
                 if (slider.style.scrollBehavior === 'auto') { // अगर ड्रैग हो रहा था
                   snapToCard(); // माउस छोड़ने पर कार्ड पर स्नैप करें
                }
            });

            slider.addEventListener('mousemove', (e) => {
                if (!isDown || questionPaperPage.dataset.viewMode !== 'card-mode') return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // '2' से गुणा करने पर ड्रैग तेज़ लगता है
                slider.scrollLeft = scrollLeft - walk;
            });

            // ड्रैग के बाद पास वाले कार्ड पर स्नैप करने के लिए हेल्पर फ़ंक्शन
            function snapToCard() {
                if (questionPaperPage.dataset.viewMode !== 'card-mode') return;
                
                slider.style.scrollBehavior = 'smooth'; // स्नैप करने के लिए स्मूथ स्क्रॉल वापस चालू करें
                const cardWidth = slider.offsetWidth;
                const currentScroll = slider.scrollLeft;
                const targetIndex = Math.round(currentScroll / cardWidth);
                
                scrollToCard(targetIndex); // यह हमारा पहले से बनाया गया फ़ंक्शन है
            }
        }
        // --- END: CARD MODE MOUSE DRAG ---
        // ======================= START: THEME SELECTOR JAVASCRIPT =======================
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        // --- START: CARD NAVIGATION BUTTON CLICKS ---
        const prevBtn = document.getElementById('prev-question-btn');
        const nextBtn = document.getElementById('next-question-btn');

        if (prevBtn && nextBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentCardIndex > 0) {
                    scrollToCard(currentCardIndex - 1);
                }
            });

            nextBtn.addEventListener('click', () => {
                // totalCards को यहाँ अपडेट करने की ज़रूरत नहीं, updateCardNavigation कर देगा
                if (currentCardIndex < totalCards - 1) {
                    scrollToCard(currentCardIndex + 1);
                }
            });
        }
        // --- END: CARD NAVIGATION BUTTON CLICKS ---
        // --- START: JUMP TO QUESTION MODAL ---
        const jumpToQBtn = document.getElementById('jump-to-q-btn');
        const jumpModalOverlay = document.getElementById('jump-modal-overlay');
        const closeJumpModalBtn = document.getElementById('close-jump-modal-btn');
        const jumpGridContainer = document.getElementById('jump-grid-container');

        if (jumpToQBtn) {
            jumpToQBtn.addEventListener('click', () => {
                populateJumpGrid(); // ग्रिड को ताज़ा करें
                jumpModalOverlay.classList.remove('jump-modal-hidden');
            });
        }
        if (closeJumpModalBtn) {
            closeJumpModalBtn.addEventListener('click', () => {
                jumpModalOverlay.classList.add('jump-modal-hidden');
            });
        }
        if (jumpModalOverlay) {
            jumpModalOverlay.addEventListener('click', (e) => {
                if (e.target === jumpModalOverlay) { // सिर्फ बाहरी काली जगह पर क्लिक करने पर बंद हो
                    jumpModalOverlay.classList.add('jump-modal-hidden');
                }
            });
        }
        if (jumpGridContainer) {
            jumpGridContainer.addEventListener('click', (e) => {
                const jumpBtn = e.target.closest('.jump-q-btn');
                if (jumpBtn) {
                    const qId = parseInt(jumpBtn.dataset.qid);
                    const qIndex = parseInt(jumpBtn.dataset.index); // 0-आधारित इंडेक्स
                    jumpToQuestion(qId, qIndex);
                    jumpModalOverlay.classList.add('jump-modal-hidden');
                }
            });
        }
        // --- END: JUMP TO QUESTION MODAL ---
        const themeDropdown = document.getElementById('theme-dropdown');
        const themeSelector = document.querySelector('.theme-selector');
        const root = document.documentElement;
        const THEME_KEY = 'selected_theme_mps';
        

        if (themeToggleBtn) { 
            const applyTheme = (theme) => {
                if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    root.setAttribute('data-theme', prefersDark ? 'dark-blue' : 'light-blue');
                } else {
                    root.setAttribute('data-theme', theme);
                }
                localStorage.setItem(THEME_KEY, theme);
            };
            themeToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('hidden');
            });
           document.addEventListener('click', (e) => {
            // Close Theme Dropdown
            if (!themeDropdown.classList.contains('hidden')) {
                 if (!e.target.closest('.theme-selector')) {
                    themeDropdown.classList.add('hidden');
                 }
            }

            // Close View Mode Dropdown
            const viewModeDropdown = document.getElementById('view-mode-dropdown');
            if (viewModeDropdown && !viewModeDropdown.classList.contains('hidden')) {
                if (!e.target.closest('.view-mode-selector')) {
                    viewModeDropdown.classList.add('hidden');
                }
            }
        });
            themeDropdown.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const selectedTheme = e.target.dataset.theme;
                    applyTheme(selectedTheme);
                    themeDropdown.classList.add('hidden');
                }
            });
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme === 'auto') {
                    applyTheme('auto');
                }
            });
            const savedTheme = localStorage.getItem(THEME_KEY) || 'auto';
            applyTheme(savedTheme);
        }
        // ======================== END: THEME SELECTOR JAVASCRIPT ========================
        // ======================= START: NEW VIEW MODE DROPDOWN LOGIC =======================
    const viewModeBtn = document.getElementById('view-mode-btn');
    const viewModeDropdown = document.getElementById('view-mode-dropdown');
    const viewModeLabel = document.getElementById('view-mode-label');
    const viewIcons = {
        'with-option': { icon: 'fa-list-ul', text: 'With Option' },
        'all-series': { icon: 'fa-sitemap', text: 'All Series' },
        'only-option': { icon: 'fa-dot-circle', text: 'Only Option' },
        'card-mode': { icon: 'fa-clone', text: 'Card Mode' }
    };

    function updateViewModeButton(mode) {
        if (!viewIcons[mode]) mode = 'with-option'; // Default fallback
        const { icon, text } = viewIcons[mode];
        if (viewModeLabel) viewModeLabel.textContent = text;
        const btnIcon = document.querySelector('#view-mode-btn i'); // More robust selector
        if (btnIcon) {
            btnIcon.className = `fas ${icon}`;
        }
    }

    if (viewModeBtn) {
        viewModeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            viewModeDropdown.classList.toggle('hidden');
            document.getElementById('theme-dropdown').classList.add('hidden'); // Close other dropdown
        });
    }

    if (viewModeDropdown) {
        viewModeDropdown.addEventListener('click', (e) => {
            e.stopPropagation(); // Stop click from bubbling to document
            const li = e.target.closest('li[data-view]');
            if (li) {
                const newMode = li.dataset.view;
                questionPaperPage.dataset.viewMode = newMode; // यह CSS को सक्रिय करता है
                updateViewModeButton(newMode);
                if (currentShiftId) {
                    localStorage.setItem(`viewMode_${currentShiftId}`, newMode);
                }
                viewModeDropdown.classList.add('hidden');
                
                // --- START: कार्ड मोड के लिए लॉजिक ---
                // अगर कार्ड मोड में जा रहे हैं, तो फ़िल्टर को 'all' पर सेट करें
                if (newMode === 'card-mode') {
                    activeFilter = 'all'; 
                    updateActiveFilterButton('all');
                }
                // नए मोड को लागू करने के लिए प्रश्नों को फिर से प्रदर्शित करें
                displayQuestions(currentSeries, activeFilter);
                // --- END: कार्ड मोड के लिए लॉजिक ---
            }
        });
    }
    // ======================== END: NEW VIEW MODE DROPDOWN LOGIC =========================
        
        // --- लीडरबोर्ड के लिए नया कोड (UPDATED) ---
        const leaderboardShiftFilter = document.getElementById('leaderboard-shift-filter');
        const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const leaderboardTableContainer = document.getElementById('leaderboard-table-container');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const leaderboardLoading = document.getElementById('leaderboard-loading');

    async function fetchAndDisplayLeaderboard(shiftFilter = 'all') {
            if (!db) return;

            leaderboardLoading.style.display = 'block';
            leaderboardBody.innerHTML = '';
            let allUsers = [];

            try {
                const shiftsToFetch = shiftFilter === 'all' ?
                    ['shift1', 'shift2', 'shift3', 'shift4', 'shift5', 'shift6'] :
                    [shiftFilter];

                for (const shiftId of shiftsToFetch) {
                   const usersSnapshot = await db.collection('userResponses').doc(shiftId).collection('users').get({ source: 'server' });
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.summary && userData.summary.rawMarks) {
                            const correct = parseInt(userData.summary.correct) || 0;
                            const incorrect = parseInt(userData.summary.incorrect) || 0;
                            const skipped = parseInt(userData.summary.skipped) || 0;
                            const validQuestions = parseInt(userData.summary.validQuestions) || 0;

                            if (validQuestions > 0 && (correct + incorrect + skipped) === validQuestions) {
                                allUsers.push({
                                    // ===== बदलाव 1: यहाँ नई जानकारी जोड़ी गई है =====
                                    name: userData.name || 'N/A',
                                    gender: userData.gender || 'N/A',
                                    area: userData.area || 'N/A',
                                    category: userData.category || 'N/A',
                                    specialCategory: userData.specialCategory || '-',
                                    // ===============================================
                                    rawMarks: parseFloat(userData.summary.rawMarks) || 0,
                                    correct: correct,
                                    incorrect: incorrect,
                                    skipped: skipped,
                                    shift: shiftId
                                });
                            }
                        }
                    });
                }
                
                const filteredUsers = allUsers.filter(user => user.rawMarks <= 180);
                filteredUsers.sort((a, b) => b.rawMarks - a.rawMarks);

                // ===== बदलाव 2: यहाँ टेबल बनाने वाले HTML में नए कॉलम (<td>) जोड़े गए हैं =====
                leaderboardBody.innerHTML = filteredUsers.map((user, index) => `
    <tr style="border-bottom: 1px solid var(--border-color);">
        <td style="padding: 0.75rem;">${index + 1}</td>
        <td style="padding: 0.75rem;">${user.name}</td>
        
        <td style="padding: 0.75rem;">${user.gender}</td>
        <td style="padding: 0.75rem;">${user.area}</td>
        <td style="padding: 0.75rem;">${user.category}</td>
        <td style="padding: 0.75rem;">${user.specialCategory}</td>
        
        <td style="padding: 0.75rem; font-weight: bold; color: black;">${user.rawMarks.toFixed(2)}</td>
        <td style="padding: 0.75rem; color: var(--success-color);">${user.correct}</td>
        <td style="padding: 0.75rem; color: var(--danger-color);">${user.incorrect}</td>
        <td style="padding: 0.75rem; color: blue;">${user.skipped}</td>
        <td style="padding: 0.75rem;">${user.shift.replace('shift', 'S')}</td>
    </tr>
`).join('');
                // ===========================================================================

            } catch (error) {
                console.error("लीडरबोर्ड डेटा लाने में त्रुटि: ", error);
                leaderboardBody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 1rem; color: var(--danger-color);">डेटा लोड करने में त्रुटि हुई।</td></tr>`;
            } finally {
                leaderboardLoading.style.display = 'none';
            }
        }
        
        if (viewLeaderboardBtn) {
            viewLeaderboardBtn.addEventListener('click', () => {
                leaderboardTableContainer.style.display = 'block';
                fetchAndDisplayLeaderboard(leaderboardShiftFilter.value);
                viewLeaderboardBtn.style.display = 'none';
            });
        }

        if (leaderboardShiftFilter) {
            leaderboardShiftFilter.addEventListener('change', () => {
                if (leaderboardTableContainer.style.display !== 'none') {
                    fetchAndDisplayLeaderboard(leaderboardShiftFilter.value);
                }
            });
        }
        // --- लीडरबोर्ड कोड का अंत ---

        if (typeof allShiftData === 'undefined') {
            document.body.innerHTML = '<h1 style="text-align:center; padding: 2rem; color: red;">Please Wait...  उत्तर कुंजी अपडेट की जा रही है।</h1>';
            return;
        }

        const shiftSelectorPage = document.getElementById('shift-selector-page');
        const questionPaperPage = document.getElementById('question-paper-page');
        const seriesSelect = document.getElementById('series-select');
        const printBtn = document.getElementById('header-print-btn');
        const pMO = document.getElementById('print-modal-overlay');
        const toggleInfoBtn = document.getElementById('toggle-info-bar-btn');
        const resetBtn = document.getElementById('reset-answers-btn');
        const questionsContainer = document.getElementById('questions-container');

   // --- START: LOGIC FOR NEW USER INFO MODAL ---
        const startTestBtn = document.getElementById('start-test-btn');
        if (startTestBtn) {
            startTestBtn.addEventListener('click', () => {
                // सभी इनपुट और ड्रॉपडाउन को सेलेक्ट करें
                const nameInput = document.getElementById('initial-student-name');
                const rollInput = document.getElementById('initial-student-roll');
                const genderSelect = document.getElementById('initial-student-gender');
                const areaSelect = document.getElementById('initial-student-area');
                const categorySelect = document.getElementById('initial-student-category');
                const specialSelect = document.getElementById('initial-student-special');

                // जांचें कि ज़रूरी फील्ड्स भरे गए हैं या नहीं (Special Category ज़रूरी नहीं है)
                if (!nameInput.value.trim() || !rollInput.value.trim() || !genderSelect.value || !areaSelect.value || !categorySelect.value) {
                    alert("कृपया नाम, रोल नंबर, जेंडर, एरिया और कैटेगरी की जानकारी भरें।");
                    return; // अगर जानकारी अधूरी है तो आगे न बढ़ें
                }

                // सभी जानकारी को localStorage में सेव करें
                localStorage.setItem('studentName_mps', nameInput.value.trim());
                localStorage.setItem('studentRoll_mps', rollInput.value.trim());
                localStorage.setItem('studentGender_mps', genderSelect.value);
                localStorage.setItem('studentArea_mps', areaSelect.value);
                localStorage.setItem('studentCategory_mps', categorySelect.value);
                localStorage.setItem('studentSpecial_mps', specialSelect.value); // यह खाली भी हो सकता है

                // अब पेपर लोड करने के लिए आगे बढ़ें
                proceedToLoadPaper(currentShiftId, true);
            });
        }
        // --- END: LOGIC FOR NEW USER INFO MODAL ---

        function showHomePage() {
            shiftSelectorPage.style.display = 'flex';
            questionPaperPage.style.display = 'none';
            if(themeSelector) themeSelector.style.display = 'block';
            currentShiftId = null;
            history.pushState({page: 'home'}, 'Home', window.location.pathname);
            window.location.hash = '';
        }

        window.addEventListener('popstate', (event) => {
            if (!event.state || event.state.page === 'home') {
                showHomePage();
            } else if (event.state.shift) {
                loadShift(event.state.shift, false);
            }
        });

        document.querySelectorAll('.shift-btn').forEach(b => b.addEventListener('click', (e) => {
            e.preventDefault();
            loadShift(b.dataset.shift, true);
        }));

        // ======================= START: MODIFIED loadShift LOGIC =======================
        function loadShift(shiftId, shouldPushState = true) {
            currentShiftId = shiftId; 

            // localStorage से सभी ज़रूरी जानकारी की जाँच करें
            const savedName = localStorage.getItem('studentName_mps');
            const savedRoll = localStorage.getItem('studentRoll_mps');
            const savedGender = localStorage.getItem('studentGender_mps');
            const savedArea = localStorage.getItem('studentArea_mps');
            const savedCategory = localStorage.getItem('studentCategory_mps');

            // अगर कोई भी ज़रूरी जानकारी मौजूद नहीं है, तो पॉपअप दिखाएं
            if (!savedName || !savedRoll || !savedGender || !savedArea || !savedCategory) {
                // पॉपअप के फील्ड्स में पुरानी जानकारी (अगर कोई है) भरें
                document.getElementById('initial-student-name').value = savedName || '';
                document.getElementById('initial-student-roll').value = savedRoll || '';
                document.getElementById('initial-student-gender').value = savedGender || '';
                document.getElementById('initial-student-area').value = savedArea || '';
                document.getElementById('initial-student-category').value = savedCategory || '';
                document.getElementById('initial-student-special').value = localStorage.getItem('studentSpecial_mps') || '';

                // पॉपअप दिखाएं
                document.getElementById('user-info-modal-overlay').style.display = 'flex';
            } else {
                // अगर सभी जानकारी मौजूद है, तो सीधे पेपर लोड करें
                proceedToLoadPaper(shiftId, shouldPushState);
            }
        }
        function proceedToLoadPaper(shiftId, shouldPushState = true) {
            document.getElementById('user-info-modal-overlay').style.display = 'none';
            shiftSelectorPage.style.display = 'none';
            questionPaperPage.style.display = 'flex';
            if(themeSelector) themeSelector.style.display = 'none';

            currentShiftData = allShiftData[shiftId];
            allQuestions = currentShiftData.questions;
            
            document.getElementById('shift-title').textContent = currentShiftData.title;

            seriesSelect.innerHTML = '';
            const availableSeries = Object.keys(currentShiftData.seriesOrder || {});
            if (availableSeries.length > 0) {
                availableSeries.forEach(seriesKey => {
                    const option = document.createElement('option');
                    option.value = seriesKey;
                    option.textContent = seriesKey;
                    seriesSelect.appendChild(option);
                });
            }

            userAnswers = JSON.parse(localStorage.getItem(`userAnswers_${shiftId}`)) || {};
            
            const savedSeries = localStorage.getItem(`currentSeries_${shiftId}`);
            currentSeries = (savedSeries && availableSeries.includes(savedSeries)) ? savedSeries : availableSeries[0] || '';
            seriesSelect.value = currentSeries;

            activeFilter = 'all';
            document.getElementById('toggle-summary-btn').textContent = 'Show Result';
            document.querySelector('.summary-bar').classList.add('hidden');
            
            if (shouldPushState) {
               history.pushState({ shift: shiftId }, '', `#${shiftId}`);
            }
            // --- START: NEW VIEW MODE LOGIC ---
        const savedViewMode = localStorage.getItem(`viewMode_${currentShiftId}`) || 'with-option'; // Default to 'with-option'
        questionPaperPage.dataset.viewMode = savedViewMode;
        updateViewModeButton(savedViewMode);
        // --- END: NEW VIEW MODE LOGIC ---
            displayQuestions(currentSeries, activeFilter);
        }
        // ======================= END: MODIFIED loadShift LOGIC =======================

        function saveData() {
            if (!currentShiftId) return;
            localStorage.setItem(`userAnswers_${currentShiftId}`, JSON.stringify(userAnswers));
            localStorage.setItem(`currentSeries_${currentShiftId}`, currentSeries);
        }
function scrollToCard(index) {
            const cardWidth = questionsContainer.offsetWidth;
            if (cardWidth > 0) {
                questionsContainer.scrollTo({
                    left: cardWidth * index,
                    behavior: 'smooth'
                });
            }
            // नोट: onscroll इवेंट नेविगेशन को अपडेट कर देगा
        }

        function updateCardNavigation(questionCards) {
            if (!questionCards) questionCards = document.getElementById('questions-container').querySelectorAll('.question-block');
            totalCards = questionCards.length;
            
            const cardCounter = document.getElementById('card-counter');
            const prevBtn = document.getElementById('prev-question-btn');
            const nextBtn = document.getElementById('next-question-btn');

            if (totalCards === 0 || !cardCounter || !prevBtn || !nextBtn) return;

            cardCounter.textContent = `${currentCardIndex + 1} / ${totalCards}`;
            prevBtn.disabled = (currentCardIndex <= 0);
            nextBtn.disabled = (currentCardIndex >= totalCards - 1);
        }
        function populateJumpGrid() {
            const jumpGridContainer = document.getElementById('jump-grid-container');
            const jumpModalTitle = document.getElementById('jump-modal-title');
            if (!jumpGridContainer || !currentShiftData.seriesOrder) return;

            // वर्तमान सीरीज के अनुसार प्रश्नों का क्रम लें
            const seriesOrder = currentShiftData.seriesOrder[currentSeries] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            jumpGridContainer.innerHTML = ''; // ग्रिड को खाली करें
            jumpModalTitle.textContent = `Jump to Question (1-${seriesOrder.length})`;

            seriesOrder.forEach((qIndex, displayIndex) => {
                const qData = allQuestions[qIndex - 1];
                if (!qData) return;

                const btn = document.createElement('button');
                btn.className = 'jump-q-btn';
                btn.textContent = displayIndex + 1; // प्रश्न संख्या (1-आधारित)
                btn.dataset.qid = qData.id; // असली प्रश्न ID
                btn.dataset.index = displayIndex; // कार्ड मोड के लिए 0-आधारित इंडेक्स

                // प्रश्न की स्थिति (status) सेट करें
                const status = getQuestionStatus(qData.id);
                btn.dataset.status = qData.deleted ? 'deleted' : status;
                
                jumpGridContainer.appendChild(btn);
            });
        }

        function jumpToQuestion(qId, displayIndex) {
            const currentViewMode = questionPaperPage.dataset.viewMode;

            if (currentViewMode === 'card-mode') {
                // कार्ड मोड में, हमें यह पक्का करना होगा कि 'All' फ़िल्टर सक्रिय है
                if (activeFilter !== 'all') {
                    activeFilter = 'all';
                    updateActiveFilterButton('all');
                    // 'All' फ़िल्टर के साथ प्रश्नों को फिर से लोड करें
                    displayQuestions(currentSeries, 'all');
                }
                // अब सही इंडेक्स पर स्क्रॉल करें
                scrollToCard(displayIndex); 
            } else {
                // लिस्ट मोड में (With Option, All Series, Only Option)
                // अगर प्रश्न फ़िल्टर के कारण छिपा है, तो 'All' फ़िल्टर पर जाएँ
                if (activeFilter !== 'all') {
                    activeFilter = 'all';
                    updateActiveFilterButton('all');
                    displayQuestions(currentSeries, 'all');
                }

                // अब प्रश्न ब्लॉक को खोजें और उस तक स्क्रॉल करें
                const qBlock = document.querySelector(`.question-block[data-question-id='${qId}']`);
                if (qBlock) {
                    qBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // प्रश्न को हाईलाइट करें
                    qBlock.style.transition = 'outline 0.1s ease-in-out';
                    qBlock.style.outline = '3px solid var(--primary-color)';
                    setTimeout(() => {
                        qBlock.style.outline = 'none';
                    }, 1500);
                }
            }
        }
       // ======================= START: MODIFIED Firebase FUNCTION =======================
        function sendAnswerToFirebase(userId) {
            if (!currentShiftId || !db) return;

            const summaryData = {
                correct: document.getElementById('correct-count').textContent,
                incorrect: document.getElementById('incorrect-count').textContent,
                skipped: document.getElementById('skipped-count').textContent,
                attempted: document.getElementById('attempted-count').textContent,
                finalRQ: document.getElementById('right-que-value').textContent,
                rawMarks: document.getElementById('raw-marks-value').textContent,
                validQuestions: document.getElementById('total-count').textContent
            };
            
            // localStorage से सभी जानकारी प्राप्त करें
            const finalName = localStorage.getItem('studentName_mps') || 'Not Provided';
            const finalRollNo = localStorage.getItem('studentRoll_mps') || 'Not Provided';
            const finalGender = localStorage.getItem('studentGender_mps') || 'Not Provided';
            const finalArea = localStorage.getItem('studentArea_mps') || 'Not Provided';
            const finalCategory = localStorage.getItem('studentCategory_mps') || 'Not Provided';
            const finalSpecial = localStorage.getItem('studentSpecial_mps') || 'None'; // अगर खाली है तो 'None'

            db.collection('userResponses')
              .doc(currentShiftId)
              .collection('users')
              .doc(userId)
              .set({
                  // पुरानी जानकारी
                  summary: summaryData,
                  series: currentSeries,
                  rollNo: finalRollNo,
                  name: finalName,
                  lastUpdated: new Date(),
                  
                  // यहाँ से नई जानकारी जोड़ी गई है
                  gender: finalGender,
                  area: finalArea,
                  category: finalCategory,
                  specialCategory: finalSpecial
              }, { merge: true })
              .then(() => {
                  console.log(`Data for User: ${userId} successfully saved to Firebase!`);
              })
              .catch((error) => {
                  console.error("Firebase Error: ", error);
              });
        }
        // ======================= END: MODIFIED Firebase FUNCTION =======================

        function getQuestionStatus(qId) {
            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return 'unattempted';
            if (qData.deleted) return 'deleted';
            
            const uAnsText = userAnswers[qId];
            if (!uAnsText) return 'unattempted';
            if (uAnsText === "अनुत्तरित प्रश्न" || uAnsText === "Question not attempted") return 'skipped';
            
            const correctAnswerText = qData.answer.substring(3);
            return uAnsText === correctAnswerText ? 'correct' : 'incorrect';
        }

        function updateSummary() {
            let c = 0, i = 0, s = 0, d = 0, attemptedForDeleted = 0;
            allQuestions.forEach(q => {
                const status = getQuestionStatus(q.id);
                if (q.deleted) {
                     d++;
                     if (userAnswers[q.id]) attemptedForDeleted++;
                     return;
                }
                if (status === 'correct') c++;
                else if (status === 'incorrect') i++;
                else if (status === 'skipped') s++;
            });
            
            const a = c + i + attemptedForDeleted;
            const totalValidQuestions = allQuestions.length - d;
            
            const unattempted = totalValidQuestions - (c + i + s);
            const warningBox = document.getElementById('unattempted-warning-item');
            if (warningBox) {
                if (unattempted > 0) {
                    document.getElementById('unattempted-count').textContent = unattempted;
                    warningBox.classList.add('visible');
                } else {
                    warningBox.classList.remove('visible');
                }
            }

            document.getElementById('total-count').textContent = totalValidQuestions;
            document.getElementById('attempted-count').textContent = a;
            document.getElementById('correct-count').textContent = c;
            document.getElementById('incorrect-count').textContent = i;
            document.getElementById('skipped-count').textContent = s;
            document.getElementById('deleted-count').textContent = d;
            
            const rQ = c - (i / 3);
            let rM = (totalValidQuestions > 0) ? rQ * (200 / totalValidQuestions) : 0;
            
            document.getElementById('right-que-value').textContent = (rQ % 1 === 0) ? rQ : rQ.toFixed(2);
            document.getElementById('raw-marks-value').textContent = rM.toFixed(2);
        }
        
        function findQuestionPositions(qId) {
            const qIndex = allQuestions.findIndex(q => q.id === qId);
            if (qIndex === -1 || !currentShiftData.seriesOrder) return `Q ID: ${qId}`;

            const positions = [];
            for (const series in currentShiftData.seriesOrder) {
                const pos = currentShiftData.seriesOrder[series].indexOf(qIndex + 1);
                if (pos !== -1) {
                    positions.push(`<strong>${series}:</strong> #${pos + 1}`);
                }
            }
            return positions.length > 0 ? positions.join(' | ') : `Q ID: ${qId}`;
        }

        function displayQuestions(series, filter = 'all') {
            const currentViewMode = questionPaperPage.dataset.viewMode;
    const cardNav = document.getElementById('card-navigation');
            questionsContainer.innerHTML = '';
            currentSeries = series;
            updateSummary();
            updateActiveFilterButton(filter);

            const seriesOrder = currentShiftData.seriesOrder || {};
            const qIndices = seriesOrder[series] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            
           const optionLabels = ['A', 'B', 'C', 'D', 'E'];
            const OPTION_LENGTH_THRESHOLD = 40; 

            qIndices.forEach((qIndex, displayNum) => {
                const qData = allQuestions[qIndex - 1];
                if (!qData) return;

                const isDeleted = qData.deleted === true;
                const status = getQuestionStatus(qData.id);
                const finalStatusForFilter = isDeleted ? (userAnswers[qData.id] ? 'deleted' : 'unattempted') : status;

              if (currentViewMode !== 'card-mode' && filter !== 'all' && filter !== finalStatusForFilter) return;
                
                const qB = document.createElement('div');
                qB.className = 'question-block';
                qB.dataset.questionId = qData.id;
                 if (isDeleted) {
                    qB.style.backgroundColor = '#f1f3f5';
                }
                
                const iB = document.createElement('div');
                iB.className = 'question-info-bar';
                iB.innerHTML = findQuestionPositions(qData.id);
                qB.appendChild(iB);
                
                const qContent = document.createElement('div');
                qContent.className = 'question-content';

                const qT = document.createElement('h3');
            qT.innerHTML = `<span class="print-q-num">${displayNum + 1}. </span> <span class="question-text">${qData.question}</span>`;
                qContent.appendChild(qT);
                
                if (qData.image) {
                    const qImg = document.createElement('img');
                    qImg.src = qData.image;
                    qImg.alt = "प्रश्न चित्र";
                    qContent.appendChild(qImg);
                }
                qB.appendChild(qContent);

                const oCont = document.createElement('div');
                oCont.className = 'options-container';
                
                const oL = document.createElement('ul');
                oL.className = 'options-list';

                const optionsAreShort = qData.options.slice(0, 4).every(opt => opt.length < OPTION_LENGTH_THRESHOLD);
                if (optionsAreShort && qData.options.length >= 4) {
                    oL.classList.add('options-grid');
                }
                
                const optionTexts = qData.options.map(opt => opt.substring(3));
                
                let shuffledOptionTexts;
                const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[series];

                if (Array.isArray(seriesOptionConfig)) {
                    shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
                } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                    const specificOrder = seriesOptionConfig[qData.id];
                    const defaultOrder = seriesOptionConfig['default'];
                    const orderToUse = specificOrder || defaultOrder;
                    shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
                } else {
                    shuffledOptionTexts = [...optionTexts];
                }
                
                shuffledOptionTexts.forEach((text, index) => {
                    const oI = document.createElement('li');
                 oI.innerHTML = `<span class="option-label">${optionLabels[index]}</span> <span class="option-text">${text}</span>`;
                    oI.dataset.rawText = text.trim();
                    oL.appendChild(oI);
                });
                oCont.appendChild(oL);
                qB.appendChild(oCont);
                questionsContainer.appendChild(qB);
                
                updateQuestionUI(qData.id);
            });

            if (questionsContainer.innerHTML === '') {
                questionsContainer.innerHTML = `<p style="text-align:center; color: var(--font-color-light); padding: 2rem;">इस फ़िल्टर में कोई प्रश्न नहीं है।</p>`;
            }
            
            if (window.MathJax) {
                MathJax.typesetPromise([questionsContainer]).catch(function (err) {
                    console.log('MathJax error: ', err);
                });
                
            }
            // --- START: CARD MODE NAVIGATION LOGIC ---
            if (currentViewMode === 'card-mode') {
                const questionCards = questionsContainer.querySelectorAll('.question-block');
                totalCards = questionCards.length;
                
                if (totalCards > 0) {
                    // वर्तमान कार्ड इंडेक्स का पता लगाएं या 0 पर सेट करें
                    const scrollLeft = questionsContainer.scrollLeft;
                    const cardWidth = questionsContainer.offsetWidth;
                    currentCardIndex = Math.round(scrollLeft / cardWidth);
                    if (isNaN(currentCardIndex) || currentCardIndex < 0) currentCardIndex = 0;
                    
                    updateCardNavigation(questionCards);
                    
                    // स्क्रॉल लिस्नर जोड़ें ताकि स्वाइप करने पर काउंटर अपडेट हो
                    questionsContainer.onscroll = () => {
                        const scrollLeft = questionsContainer.scrollLeft;
                        const cardWidth = questionsContainer.offsetWidth;
                        currentCardIndex = Math.round(scrollLeft / cardWidth);
                        updateCardNavigation(questionCards);
                    };
                } else {
                    cardNav.style.display = 'none'; // कोई प्रश्न नहीं है तो नेविगेशन छिपा दें
                }
            } else {
                // अगर कार्ड मोड में नहीं हैं, तो लिस्नर हटा दें
                questionsContainer.onscroll = null;
            }
            // --- END: CARD MODE NAVIGATION LOGIC ---
        }
        
        function updateQuestionUI(qId) {
            const qBlock = document.querySelector(`.question-block[data-question-id='${qId}']`);
            if (!qBlock) return;

            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return;

            const status = getQuestionStatus(qId);
            const isDeleted = qData.deleted === true;
            const optionsList = qBlock.querySelector('.options-list');
            const optionsContainer = qBlock.querySelector('.options-container');
            let answerDisplay = qBlock.querySelector('.correct-answer-display');

            optionsList.querySelectorAll('li').forEach(li => {
                li.classList.remove('correct', 'incorrect', 'special', 'selected-neutral');
            });

            const userAnswerText = userAnswers[qId];
            if (userAnswerText) {
                const selectedLi = Array.from(optionsList.querySelectorAll('li')).find(li => li.dataset.rawText === userAnswerText);
                if (selectedLi) {
                    if (isDeleted) {
                        selectedLi.classList.add('selected-neutral');
                    } else if (status === 'correct') selectedLi.classList.add('correct');
                    else if (status === 'incorrect') selectedLi.classList.add('incorrect');
                    else if (status === 'skipped') selectedLi.classList.add('special');
                }
            }

            if (answerDisplay) answerDisplay.remove();

            if (isDeleted) {
                answerDisplay = document.createElement('div');
                answerDisplay.className = 'correct-answer-display';
                answerDisplay.innerHTML = 'Status: <strong style="color: var(--danger-color);">Deleted</strong>';
                optionsContainer.appendChild(answerDisplay);
            } else if (status !== 'unattempted') {
                answerDisplay = document.createElement('div');
                answerDisplay.className = 'correct-answer-display';
                
                const optionLabels = ['A)', 'B)', 'C)', 'D)', 'E)'];
                const optionTexts = qData.options.map(opt => opt.substring(3));
                
                let shuffledOptionTexts;
                const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[currentSeries];
                if (Array.isArray(seriesOptionConfig)) {
                    shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
                } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                    const specificOrder = seriesOptionConfig[qData.id];
                    const defaultOrder = seriesOptionConfig['default'];
                    const orderToUse = specificOrder || defaultOrder;
                    shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
                } else {
                    shuffledOptionTexts = [...optionTexts];
                }

                const correctAnswerText = qData.answer.substring(3);
                const newCorrectIndex = shuffledOptionTexts.indexOf(correctAnswerText);
                let dynamicCorrectAnswer = qData.answer;
                if (newCorrectIndex !== -1) {
                     dynamicCorrectAnswer = `${optionLabels[newCorrectIndex]} ${correctAnswerText}`;
                }
                
                answerDisplay.innerHTML = `Correct Ans: <strong style="color: var(--success-color);">${dynamicCorrectAnswer}</strong>`;
                optionsContainer.appendChild(answerDisplay);
            }
            // --- START: JUMP MODAL LIVE UPDATE ---
            // पॉपअप के अंदर संबंधित बटन को खोजें
            const jumpBtn = document.querySelector(`#jump-grid-container .jump-q-btn[data-qid='${qId}']`);
            if (jumpBtn) {
                // उसका status अपडेट करें ताकि रंग बदल जाए
                jumpBtn.dataset.status = isDeleted ? 'deleted' : status;
            }
            // --- END: JUMP MODAL LIVE UPDATE ---
        }
   
        questionsContainer.addEventListener('click', (e) => {
            const clickedLi = e.target.closest('li');
            if (!clickedLi) return;

            const questionBlock = e.target.closest('.question-block');
            if (!questionBlock) return;

            const qId = parseInt(questionBlock.dataset.questionId);
            const qData = allQuestions.find(q => q.id === qId);
            if (!qData) return;

            userAnswers[qId] = clickedLi.dataset.rawText;
            
            saveData(); 
            updateQuestionUI(qId);
            updateSummary(); 

            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (!userId) {
                userId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(`userId_${currentShiftId}`, userId);
            }
        
            const isDeleted = qData.deleted === true;
            const newStatus = getQuestionStatus(qId);
            const finalStatusForFilter = isDeleted ? (userAnswers[qId] ? 'deleted' : 'unattempted') : newStatus;

            if (activeFilter !== 'all' && activeFilter !== finalStatusForFilter) {
                setTimeout(() => { questionBlock.style.display = 'none'; }, 200);
            }
        });
   
       // ================= START: EXIT SAVE CODE (NEW) =================
        // पेज बंद होने पर डेटा बचाने के लिए यह अंतिम और सबसे सरल कोड है।

        function finalSaveOnExit() {
            // यह सुनिश्चित करें कि currentShiftId और userId मौजूद हैं
            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (!userId || !currentShiftId) {
                console.log("Exit Save: उपयोगकर्ता की जानकारी नहीं मिली, सेव नहीं किया जा रहा है।");
                return; // अगर जानकारी नहीं है तो बाहर निकलें
            }

            console.log("पेज बंद हो रहा है, अंतिम डेटा सहेजने का प्रयास किया जा रहा है...");
            
            // 1. सबसे महत्वपूर्ण: स्क्रीन पर नवीनतम स्कोर की गणना करें
            // ताकि sendAnswerToFirebase फ़ंक्शन सही डेटा पढ़े
            updateSummary();
            
            // 2. अब Firebase पर डेटा भेजें (वही फ़ंक्शन जो प्रिंट बटन करता है)
            sendAnswerToFirebase(userId);
        }

        // 'pagehide' इवेंट का उपयोग करें, यह पेज से बाहर निकलने के लिए सबसे विश्वसनीय इवेंट है।
        window.addEventListener('pagehide', finalSaveOnExit);

        // ================== END: EXIT SAVE CODE (NEW) ==================
           
        function updateActiveFilterButton(filter) {
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-buttons button[data-filter="${filter}"]`).classList.add('active');
        }

        seriesSelect.addEventListener('change', (e) => {
            displayQuestions(e.target.value, activeFilter);
            saveData();
        });
        
        resetBtn.addEventListener('click', () => {
            if (confirm("क्या आप वाकई इस पेपर के लिए अपने सभी उत्तर हटाना चाहते हैं?")) {
                userAnswers = {};
                saveData();
                let userId = localStorage.getItem(`userId_${currentShiftId}`);
                if (userId) {
                    sendAnswerToFirebase(userId);
                }
                displayQuestions(currentSeries, 'all');
            }
        });

        document.querySelectorAll('.filter-buttons button').forEach(b => b.addEventListener('click', () => {
            activeFilter = b.dataset.filter;
            displayQuestions(currentSeries, activeFilter);
        }));

        document.getElementById('toggle-summary-btn').addEventListener('click', (e) => {
            const sB = document.querySelector('.summary-bar');
            sB.classList.toggle('hidden');
            e.target.textContent = sB.classList.contains('hidden') ? 'Show Result' : 'Hide Result';
        });
        
      
        
        function populatePrintHeader(name, rollNo){
            document.getElementById('print-title').textContent = document.getElementById('shift-title').textContent;
            document.getElementById('print-name').textContent = name;
            document.getElementById('print-roll').textContent = rollNo;
            document.getElementById('print-series').textContent = seriesSelect.value;
            document.getElementById('print-full-total').textContent = allQuestions.length;
            document.getElementById('print-valid-total').textContent = document.getElementById('total-count').textContent;
            document.getElementById('print-attempted').textContent = document.getElementById('attempted-count').textContent;
            document.getElementById('print-correct-cell').textContent = document.getElementById('correct-count').textContent;
            document.getElementById('print-incorrect-cell').textContent = document.getElementById('incorrect-count').textContent;
            document.getElementById('print-skipped').textContent = document.getElementById('skipped-count').textContent;
            document.getElementById('print-deleted').textContent = document.getElementById('deleted-count').textContent;
            document.getElementById('print-final-rq-display').textContent = document.getElementById('right-que-value').textContent;
            document.getElementById('print-raw-marks-display').textContent = document.getElementById('raw-marks-value').textContent;
        }

        function openPrintWindow(content, bodyClass = '') {
            const oldFrame = document.getElementById('printf');
            if (oldFrame) { oldFrame.remove(); }

            const printFrame = document.createElement('iframe');
            printFrame.id = 'printf';
            printFrame.style.position = 'absolute';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            printFrame.style.left = '-9999px';
            document.body.appendChild(printFrame);

            const styles = document.getElementById('main-styles').innerHTML;
            const fontLink = `<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">`;
           
            const printLogic = `
                <script>
                    (() => {
                        let hasPrinted = false;
                        const triggerPrint = () => {
                            if (hasPrinted) return;
                            hasPrinted = true;
                            try {
                                window.focus(); window.print();
                            } catch (e) { console.error("Print failed:", e); } 
                            finally {
                                setTimeout(() => {
                                    const frame = parent.document.getElementById('printf');
                                    if (frame) frame.remove();
                                }, 1000);
                            }
                        };
                        const runPrintProcess = () => {
                          const mathJaxPromise = Promise.resolve();
                            const imagePromises = [...document.querySelectorAll('img')].map(img => {
                                if (img.complete) return Promise.resolve();
                                return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                            });
                            Promise.all([mathJaxPromise, ...imagePromises])
                                .then(() => { triggerPrint(); })
                                .catch(err => { console.error('Pre-print error:', err); triggerPrint(); });
                            setTimeout(triggerPrint, 8000);
                        };
                        window.addEventListener('load', runPrintProcess);
                    })();
                <\/script>
            `;
          const printHideInfoClass = (document.getElementById('question-paper-page').dataset.viewMode === 'all-series') ? '' : 'hide-q-info';
      const frameContent = `
        <html><head><title>Print</title>${fontLink}<style>${styles}</style></head>
        <body class="${bodyClass} ${printHideInfoClass}">
            ${content}${printLogic}</body></html>`;

            printFrame.contentDocument.open();
            printFrame.contentDocument.write(frameContent);
            printFrame.contentDocument.close();
        }

        function getCorrectOptionForSeries(qData, series) {
            if (qData.deleted) return 'Delete';
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];
            const correctAnswerText = qData.answer.substring(3);
            const optionTexts = qData.options.map(opt => opt.substring(3));
            
            let shuffledOptionTexts;
            const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[series];
            if (Array.isArray(seriesOptionConfig)) {
                shuffledOptionTexts = seriesOptionConfig.map(index => optionTexts[index]);
            } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                const specificOrder = seriesOptionConfig[qData.id];
                const defaultOrder = seriesOptionConfig['default'];
                const orderToUse = specificOrder || defaultOrder;
                shuffledOptionTexts = orderToUse ? orderToUse.map(index => optionTexts[index]) : [...optionTexts];
            } else {
                shuffledOptionTexts = [...optionTexts];
            }
            
            const newCorrectIndex = shuffledOptionTexts.indexOf(correctAnswerText);
            return (newCorrectIndex !== -1) ? optionLabels[newCorrectIndex] : '?';
        }

        function generateAndPrintOfficialKey() {
            const container = document.getElementById('official-key-print-container');
            let html = `<div class="official-key-header">
                    <h1>चतुर्थ श्रेणी कर्मचारी प्राथमिक उत्तर कुंजी</h1>
                    <p>${currentShiftData.title} | पेपर कोड: ${currentSeries}</p>
                </div><div class="official-key-grid">`;

            const seriesOrder = currentShiftData.seriesOrder[currentSeries] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            const totalQuestions = seriesOrder.length;
            const questionsPerColumn = 30;
            const numColumns = Math.ceil(totalQuestions / questionsPerColumn);
            
            for (let c = 0; c < numColumns; c++) {
                html += `<div class="official-key-column"><table class="official-key-table"><thead><tr><th>प्रश्न</th><th>उत्तर</th></tr></thead><tbody>`;
                const start = c * questionsPerColumn;
                const end = Math.min(start + questionsPerColumn, totalQuestions);
                for (let i = start; i < end; i++) {
                    const displayNum = i + 1;
                    const qIndex = seriesOrder[i];
                    const qData = allQuestions[qIndex - 1];
                    if(qData) {
                        const correctOpt = getCorrectOptionForSeries(qData, currentSeries);
                        html += `<tr><td>${displayNum}</td><td>${correctOpt}</td></tr>`;
                    }
                }
                html += `</tbody></table></div>`;
            }

            html += `</div>`;
            html += `<div class="official-key-footer"><p>नोट - यह उत्तर कुंजी बोर्ड द्वारा जारी प्राथमिक उत्तर कुंजी के आधार पर Auto Generated है</p></div>`;

            container.innerHTML = html;
            openPrintWindow(container.innerHTML);
        }

        function generateAndPrintOMR(name, rollNo) {
            populatePrintHeader(name, rollNo); 
            const container = document.getElementById('omr-print-container');
            container.innerHTML = ''; 

            const headerSource = document.getElementById('print-fallback-details');
            container.appendChild(headerSource.cloneNode(true));
            
            const grid = document.createElement('div');
            grid.className = 'omr-grid';
            
            const seriesOrder = currentShiftData.seriesOrder[currentSeries] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
            const totalQuestions = seriesOrder.length;
            const questionsPerColumn = Math.ceil(totalQuestions / 4);
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];

            for (let c = 0; c < 4; c++) {
                const column = document.createElement('div');
                column.className = 'omr-column';
                const start = c * questionsPerColumn;
                const end = Math.min(start + questionsPerColumn, totalQuestions);

                for (let i = start; i < end; i++) {
                    const displayNum = i + 1;
                    const qIndex = seriesOrder[i];
                    if (!allQuestions[qIndex - 1]) continue;
                    const qData = allQuestions[qIndex - 1];
                    
                    const status = getQuestionStatus(qData.id);
                    const isDeleted = qData.deleted === true;

                    const row = document.createElement('div');
                    row.className = 'omr-row';
                    
                    const qNumDiv = document.createElement('div');
                    qNumDiv.className = 'omr-q-num';
                    qNumDiv.textContent = `${displayNum}.`;
                    
                    if (isDeleted) {
                        row.style.opacity = '0.7';
                    } else if (status === 'incorrect') {
                        qNumDiv.style.color = 'red';
                    } else if (status === 'skipped') {
                        qNumDiv.style.color = 'blue';
                    }
                    row.appendChild(qNumDiv);
                    
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'omr-options';
                    
                    const userAnswerText = userAnswers[qData.id];
                    let filledOptionIndex = -1;

                    if (userAnswerText) {
                        const originalOptionTexts = qData.options.map(opt => opt.substring(3));
                        let shuffledOptionTexts;
                        const seriesOptionConfig = currentShiftData.seriesOptionOrder?.[currentSeries];
                         if (Array.isArray(seriesOptionConfig)) {
                            shuffledOptionTexts = seriesOptionConfig.map(index => originalOptionTexts[index]);
                        } else if (typeof seriesOptionConfig === 'object' && seriesOptionConfig !== null) {
                            const specificOrder = seriesOptionConfig[qData.id];
                            const defaultOrder = seriesOptionConfig['default'];
                            const orderToUse = specificOrder || defaultOrder;
                            shuffledOptionTexts = orderToUse ? orderToUse.map(index => originalOptionTexts[index]) : [...originalOptionTexts];
                        } else {
                            shuffledOptionTexts = [...originalOptionTexts];
                        }

                        const userAnsIndex = shuffledOptionTexts.findIndex(txt => txt.trim() === userAnswerText.trim());
                        if(userAnsIndex !== -1) filledOptionIndex = userAnsIndex;
                    }

                    optionLabels.forEach((label, index) => {
                         const bubble = document.createElement('div');
                         bubble.className = 'omr-bubble';
                         bubble.textContent = label;
                         if (index === filledOptionIndex) {
                            if(isDeleted) {
                                bubble.classList.add('filled-neutral');
                            } else {
                                bubble.classList.add('filled');
                            }
                         }
                         optionsDiv.appendChild(bubble);
                    });

                    row.appendChild(optionsDiv);
                    column.appendChild(row);
                }
                grid.appendChild(column);
            }
            container.appendChild(grid);
            
            openPrintWindow(container.innerHTML, 'omr-print-body');
        }

        function triggerPaperPrint(name, rollNo) {
            populatePrintHeader(name, rollNo); 
            const headerHTML = document.getElementById('print-fallback-details').outerHTML;
            const questionsHTML = document.getElementById('questions-container').outerHTML;
            openPrintWindow(headerHTML + questionsHTML);
        }

        printBtn.addEventListener('click', () => { 
            const savedName = localStorage.getItem('studentName_mps');
            const savedRoll = localStorage.getItem('studentRoll_mps');
            if (savedName) document.getElementById('student-name').value = savedName;
            if (savedRoll) document.getElementById('student-roll').value = savedRoll;
            pMO.style.display = 'flex'; 
        });

        document.getElementById('cancel-print').addEventListener('click', () => { pMO.style.display = 'none'; })
            // START: Auto-save name/roll from print popup on input change
        document.getElementById('student-name').addEventListener('input', (e) => {
            localStorage.setItem('studentName_mps', e.target.value.trim());
        });
        document.getElementById('student-roll').addEventListener('input', (e) => {
            localStorage.setItem('studentRoll_mps', e.target.value.trim());
        });
        // END: Auto-save logic
        
        document.getElementById('confirm-print').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if (!name || !rollNo) { alert("नाम और रोल नंबर दोनों आवश्यक हैं।"); return; }
            
            localStorage.setItem('studentName_mps', name);
            localStorage.setItem('studentRoll_mps', rollNo);
            
            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (userId) sendAnswerToFirebase(userId);

            pMO.style.display = 'none';
            triggerPaperPrint(name, rollNo);
        });

        document.getElementById('get-omr-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if (!name || !rollNo) { alert("नाम और रोल नंबर दोनों आवश्यक हैं।"); return; }

            localStorage.setItem('studentName_mps', name);
            localStorage.setItem('studentRoll_mps', rollNo);

            let userId = localStorage.getItem(`userId_${currentShiftId}`);
            if (userId) sendAnswerToFirebase(userId);

            pMO.style.display = 'none';
            generateAndPrintOMR(name, rollNo);
        });
        document.getElementById('get-official-key-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const rollNo = document.getElementById('student-roll').value.trim();
            if(name) localStorage.setItem('studentName_mps', name);
            if(rollNo) localStorage.setItem('studentRoll_mps', rollNo);
             pMO.style.display = 'none';
             generateAndPrintOfficialKey();
        });

        const shiftIdFromUrl = window.location.hash.substring(1);
        if (shiftIdFromUrl && allShiftData[shiftIdFromUrl]) {
            loadShift(shiftIdFromUrl);
        } else {
            showHomePage();
        }
    }); 

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => { console.log('ServiceWorker registration successful'); })
                .catch(error => { console.log('ServiceWorker registration failed: ', error); });
        });
    }
</script>
</body>
</html>
